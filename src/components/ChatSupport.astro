---
// Chatwoot Live Chat Integration - Optimized for performance
---

<script>
  // Defer chat widget loading until after page is interactive
  function loadChatWidget() {
    const BASE_URL = "https://chat.tangleapps.vip";
    const script = document.createElement('script');
    script.src = BASE_URL + "/packs/js/sdk.js";
    script.async = true;
    script.defer = true;
    
    script.onload = function() {
      if (window.chatwootSDK) {
        window.chatwootSDK.run({
          websiteToken: 'kZ6MVSqzFdTixasHXKbRmJRZ',
          baseUrl: BASE_URL
        });
        
        // Track chat widget interactions
        window.addEventListener('chatwoot:open', function() {
          window.dataLayer = window.dataLayer || [];
          window.dataLayer.push({
            'event': 'chat_opened',
            'chat_method': 'widget_bubble'
          });
        });
      }
    };
    
    document.body.appendChild(script);
  }

  // Strategy 1: Load after page becomes idle
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      loadChatWidget();
    }, { timeout: 3000 }); // Fallback to 3 seconds
  } else {
    // Fallback for browsers without requestIdleCallback
    window.addEventListener('load', () => {
      setTimeout(loadChatWidget, 2000); // Wait 2 seconds after page load
    });
  }

  // Strategy 2: Also load on user interaction (whichever comes first)
  let widgetLoaded = false;
  const interactionEvents = ['scroll', 'mousemove', 'touchstart', 'click'];
  
  function handleInteraction() {
    if (!widgetLoaded) {
      widgetLoaded = true;
      loadChatWidget();
      // Remove all listeners once loaded
      interactionEvents.forEach(event => {
        window.removeEventListener(event, handleInteraction, { passive: true });
      });
    }
  }

  // Add passive listeners for better performance
  interactionEvents.forEach(event => {
    window.addEventListener(event, handleInteraction, { passive: true, once: true });
  });
</script>