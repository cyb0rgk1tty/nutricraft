---
interface Category {
  id: string;
  name: string;
  slug: string;
}

interface DosageForm {
  id: string;
  name: string;
  count: number;
}

interface Props {
  categories: Category[];
  dosageForms: DosageForm[];
  totalProducts: number;
}

const { categories, dosageForms, totalProducts } = Astro.props;
---

<div class="sticky top-16 md:top-20 z-40 bg-white/95 backdrop-blur-sm border-b border-gray-100 shadow-sm">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4">

    <!-- Mobile: Dropdown Selects -->
    <div class="md:hidden space-y-3">
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="category-select" class="block text-xs font-medium text-gray-500 mb-1">Category</label>
          <select
            id="category-select"
            class="w-full px-3 py-2.5 bg-white border border-gray-200 rounded-lg text-dark-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-mint-500 focus:border-mint-500"
          >
            <option value="all">All Categories</option>
            {categories.map((category) => (
              <option value={category.id}>{category.name}</option>
            ))}
          </select>
        </div>
        <div>
          <label for="dosage-select" class="block text-xs font-medium text-gray-500 mb-1">Dosage Form</label>
          <select
            id="dosage-select"
            class="w-full px-3 py-2.5 bg-white border border-gray-200 rounded-lg text-dark-700 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-mint-500 focus:border-mint-500"
          >
            <option value="all">All Forms</option>
            {dosageForms.map((form) => (
              <option value={form.id}>{form.name} ({form.count})</option>
            ))}
          </select>
        </div>
      </div>
    </div>

    <!-- Desktop: Two Filter Rows -->
    <div class="hidden md:block space-y-4">
      <!-- Dosage Form Filter -->
      <div class="flex items-center justify-center gap-2">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mr-2">Format:</span>
        <div id="dosage-tabs" class="flex flex-wrap gap-2 justify-center">
          <button
            data-dosage="all"
            class="dosage-tab px-3 py-1.5 rounded-full border font-medium text-xs transition-all duration-200 whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-mint-500 focus:ring-offset-1 bg-mint-600 text-white border-mint-600"
          >
            All Forms
          </button>
          {dosageForms.map((form) => (
            <button
              data-dosage={form.id}
              class="dosage-tab px-3 py-1.5 rounded-full border font-medium text-xs transition-all duration-200 whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-mint-500 focus:ring-offset-1 bg-white text-dark-700 border-gray-200 hover:border-mint-500 hover:text-mint-600"
            >
              {form.name}
              <span class="ml-1 text-gray-400">({form.count})</span>
            </button>
          ))}
        </div>
      </div>

      <!-- Category Filter -->
      <div class="flex items-center justify-center gap-2">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider mr-2">Category:</span>
        <div
          id="category-tabs"
          class="flex flex-wrap gap-2 justify-center"
          role="tablist"
          aria-label="Filter by category"
        >
          <button
            role="tab"
            aria-selected="true"
            aria-controls="catalog-products"
            data-category="all"
            class="filter-tab px-3 py-1.5 rounded-full border font-medium text-xs transition-all duration-200 whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-mint-500 focus:ring-offset-1 bg-mint-600 text-white border-mint-600"
          >
            All Categories
          </button>
          {categories.map((category) => (
            <button
              role="tab"
              aria-selected="false"
              aria-controls="catalog-products"
              data-category={category.id}
              class="filter-tab px-3 py-1.5 rounded-full border font-medium text-xs transition-all duration-200 whitespace-nowrap focus:outline-none focus:ring-2 focus:ring-mint-500 focus:ring-offset-1 bg-white text-dark-700 border-gray-200 hover:border-mint-500 hover:text-mint-600"
            >
              {category.name}
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- Product Count -->
    <div class="text-center pt-3 text-sm text-dark-500">
      Showing <span id="product-count" class="font-semibold text-dark-700">{totalProducts}</span> products
    </div>
  </div>
</div>

<script>
  // State
  let currentCategory = 'all';
  let currentDosage = 'all';

  // Elements
  const filterTabs = document.querySelectorAll('.filter-tab');
  const dosageTabs = document.querySelectorAll('.dosage-tab');
  const categorySelect = document.getElementById('category-select') as HTMLSelectElement;
  const dosageSelect = document.getElementById('dosage-select') as HTMLSelectElement;
  const categorySections = document.querySelectorAll('section[data-category]');
  const productCards = document.querySelectorAll('article[data-product]');
  const productCount = document.getElementById('product-count');

  // Update product count with animation
  function updateProductCount(count: number) {
    if (productCount) {
      productCount.style.transition = 'opacity 150ms ease';
      productCount.style.opacity = '0';
      setTimeout(() => {
        productCount.textContent = count.toString();
        productCount.style.opacity = '1';
      }, 150);
    }
  }

  // Apply combined filters
  function applyFilters() {
    let visibleCount = 0;

    // First, show/hide products based on both filters
    productCards.forEach(card => {
      const cardCategory = card.getAttribute('data-category');
      const cardDosage = card.getAttribute('data-dosage');

      const matchesCategory = currentCategory === 'all' || cardCategory === currentCategory;
      const matchesDosage = currentDosage === 'all' || cardDosage === currentDosage;

      if (matchesCategory && matchesDosage) {
        (card as HTMLElement).style.display = 'grid';
        visibleCount++;
      } else {
        (card as HTMLElement).style.display = 'none';
      }
    });

    // Show/hide category sections based on whether they have visible products
    categorySections.forEach(section => {
      const visibleCards = section.querySelectorAll('article[data-product][style*="display: grid"], article[data-product]:not([style*="display: none"])');
      let hasVisibleCards = false;

      section.querySelectorAll('article[data-product]').forEach(card => {
        if ((card as HTMLElement).style.display !== 'none') {
          hasVisibleCards = true;
        }
      });

      (section as HTMLElement).style.display = hasVisibleCards ? 'block' : 'none';
    });

    updateProductCount(visibleCount);
  }

  // Update active category tab styling
  function setActiveCategoryTab(category: string) {
    filterTabs.forEach(t => {
      t.classList.remove('bg-mint-600', 'text-white', 'border-mint-600');
      t.classList.add('bg-white', 'text-dark-700', 'border-gray-200');
      t.setAttribute('aria-selected', 'false');
    });

    const activeTab = document.querySelector(`.filter-tab[data-category="${category}"]`);
    if (activeTab) {
      activeTab.classList.remove('bg-white', 'text-dark-700', 'border-gray-200');
      activeTab.classList.add('bg-mint-600', 'text-white', 'border-mint-600');
      activeTab.setAttribute('aria-selected', 'true');
    }
  }

  // Update active dosage tab styling
  function setActiveDosageTab(dosage: string) {
    dosageTabs.forEach(t => {
      t.classList.remove('bg-mint-600', 'text-white', 'border-mint-600');
      t.classList.add('bg-white', 'text-dark-700', 'border-gray-200');
    });

    const activeTab = document.querySelector(`.dosage-tab[data-dosage="${dosage}"]`);
    if (activeTab) {
      activeTab.classList.remove('bg-white', 'text-dark-700', 'border-gray-200');
      activeTab.classList.add('bg-mint-600', 'text-white', 'border-mint-600');
    }
  }

  // Handle category tab clicks
  filterTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      currentCategory = tab.getAttribute('data-category') || 'all';
      setActiveCategoryTab(currentCategory);
      applyFilters();

      // Sync mobile dropdown
      if (categorySelect) {
        categorySelect.value = currentCategory;
      }
    });
  });

  // Handle dosage tab clicks
  dosageTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      currentDosage = tab.getAttribute('data-dosage') || 'all';
      setActiveDosageTab(currentDosage);
      applyFilters();

      // Sync mobile dropdown
      if (dosageSelect) {
        dosageSelect.value = currentDosage;
      }
    });
  });

  // Handle mobile category dropdown change
  if (categorySelect) {
    categorySelect.addEventListener('change', () => {
      currentCategory = categorySelect.value;
      setActiveCategoryTab(currentCategory);
      applyFilters();
    });
  }

  // Handle mobile dosage dropdown change
  if (dosageSelect) {
    dosageSelect.addEventListener('change', () => {
      currentDosage = dosageSelect.value;
      setActiveDosageTab(currentDosage);
      applyFilters();
    });
  }

  // Keyboard navigation for category tabs
  const tabContainer = document.getElementById('category-tabs');
  if (tabContainer) {
    tabContainer.addEventListener('keydown', (e) => {
      const tabs = Array.from(tabContainer.querySelectorAll('[role="tab"]'));
      const currentIndex = tabs.indexOf(document.activeElement as Element);

      if (currentIndex === -1) return;

      let nextIndex = currentIndex;

      if (e.key === 'ArrowRight') {
        e.preventDefault();
        nextIndex = (currentIndex + 1) % tabs.length;
      } else if (e.key === 'ArrowLeft') {
        e.preventDefault();
        nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
      } else if (e.key === 'Home') {
        e.preventDefault();
        nextIndex = 0;
      } else if (e.key === 'End') {
        e.preventDefault();
        nextIndex = tabs.length - 1;
      }

      if (nextIndex !== currentIndex) {
        (tabs[nextIndex] as HTMLElement).focus();
      }
    });
  }
</script>
