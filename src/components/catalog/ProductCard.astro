---
/**
 * ProductCard Component
 * Displays a single product with generated Supplement Facts label and details
 * Layout: Label on left, product info on right (stacks on mobile)
 */

import SupplementFactsLabel from './SupplementFactsLabel.astro';
import { getProductIngredientNamesFromComponent, type ComponentProduct } from '../../utils/db';

interface Ingredient {
  name: string;
  amount: string;
  unit: string;
  dailyValue?: string;
  source?: string;
}

interface Product {
  id: string;
  sku?: string;
  name: string;
  categoryId: string;
  description: string;
  servingSize: string;
  servingsPerContainer: number | string;
  keyIngredients?: string[];
  ingredients?: Ingredient[];
  otherIngredients?: string;
  allergenInfo?: string;
  dosageForm?: string;
}

interface Props {
  product: Product;
  categoryName?: string;
  loading?: 'eager' | 'lazy';
}

const { product, categoryName, loading = 'lazy' } = Astro.props;

// Format dosage form for display
const formatDosageForm = (form?: string) => {
  if (!form) return 'Capsules';
  return form.charAt(0).toUpperCase() + form.slice(1);
};
---

<article
  class="product-row relative bg-white rounded-xl border border-gray-200 p-4 md:p-6 transition-all duration-200 hover:shadow-lg hover:-translate-y-0.5"
  data-product={product.id}
  data-category={product.categoryId}
  data-dosage={product.dosageForm || 'capsules'}
  data-ingredients={JSON.stringify(getProductIngredientNamesFromComponent(product))}
  data-sku={product.sku || ''}
  data-name={product.name.toLowerCase()}
>
  <!-- SKU Badge - hidden on mobile, shown on desktop -->
  {product.sku && (
    <div class="hidden md:block absolute top-3 right-3 px-2 py-1 bg-gray-100 text-gray-600 text-xs font-mono font-medium rounded border border-gray-200">
      {product.sku}
    </div>
  )}

  <div class="grid grid-cols-1 md:grid-cols-[300px_1fr] gap-6 md:gap-8">
    <!-- Mobile SKU Badge - shown above label on mobile only -->
    {product.sku && (
      <div class="md:hidden flex justify-end mb-2">
        <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs font-mono font-medium rounded border border-gray-200">
          {product.sku}
        </span>
      </div>
    )}

    <!-- Supplement Facts Label (Generated) -->
    <div class="label-container flex items-start justify-center">
      <div class="bg-gray-50 rounded-lg p-4">
        <SupplementFactsLabel
          servingSize={product.servingSize}
          servingsPerContainer={product.servingsPerContainer}
          ingredients={product.ingredients}
          otherIngredients={product.otherIngredients}
          allergenInfo={product.allergenInfo}
        />
      </div>
    </div>

    <!-- Product Information -->
    <div class="product-info flex flex-col justify-center gap-3">
      <!-- Product Name -->
      <h3 class="text-xl md:text-2xl font-semibold text-gray-900 leading-tight">
        {product.name}
      </h3>

      <!-- Meta Information -->
      <div class="flex flex-wrap items-center gap-3 md:gap-4">
        <!-- Serving Size -->
        <span class="flex items-center gap-1.5 text-sm text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714a2.25 2.25 0 00.659 1.591L19 14.5M14.25 3.104c.251.023.501.05.75.082M19 14.5l-2.47 2.47a2.25 2.25 0 01-1.591.659H9.061a2.25 2.25 0 01-1.591-.659L5 14.5m14 0V6a2.25 2.25 0 00-2.25-2.25H7.25A2.25 2.25 0 005 6v8.5" />
          </svg>
          {product.servingSize}
        </span>

        <!-- Servings Per Container -->
        <span class="flex items-center gap-1.5 text-sm text-gray-600">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
          </svg>
          {product.servingsPerContainer} servings
        </span>

        <!-- Dosage Form Badge -->
        <span class="px-2.5 py-1 bg-mint-100 text-primary text-xs font-semibold rounded-full uppercase tracking-wide">
          {formatDosageForm(product.dosageForm)}
        </span>
      </div>

      <!-- Description -->
      <p class="text-gray-600 text-sm md:text-base leading-relaxed mt-1">
        {product.description}
      </p>

      <!-- Key Ingredients (fallback if no full ingredients data) -->
      {(!product.ingredients || product.ingredients.length === 0) && product.keyIngredients && product.keyIngredients.length > 0 && (
        <div class="mt-3">
          <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">
            Key Ingredients
          </h4>
          <div class="flex flex-wrap gap-2">
            {product.keyIngredients.map((ingredient) => (
              <span class="px-2.5 py-1 bg-gray-100 text-gray-700 text-xs font-medium rounded-md border border-gray-200">
                {ingredient}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
</article>
