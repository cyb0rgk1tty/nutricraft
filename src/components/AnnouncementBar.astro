---
/**
 * AnnouncementBar Component
 *
 * Displays a site-wide announcement bar at the top of all pages.
 * Can be toggled on/off and message edited via admin settings.
 * Users can dismiss it (persisted via localStorage).
 */

import { getActiveAnnouncement } from '../utils/announcements';

const announcement = await getActiveAnnouncement();

// Generate a simple hash of the message for dismiss tracking
// When message changes, the bar will show again
const messageHash = announcement?.message
  ? btoa(announcement.message).slice(0, 8)
  : '';

// Color classes mapping
const colorClasses = {
  yellow: {
    bg: 'bg-amber-100',
    border: 'border-amber-200',
    text: 'text-amber-900',
    dismiss: 'text-amber-700 hover:text-amber-900',
  },
  green: {
    bg: 'bg-green-100',
    border: 'border-green-200',
    text: 'text-green-900',
    dismiss: 'text-green-700 hover:text-green-900',
  },
};

const color = announcement?.color || 'yellow';
const classes = colorClasses[color] || colorClasses.yellow;
---

{announcement && (
  <div
    id="announcement-bar"
    data-hash={messageHash}
    class:list={[classes.bg, "border-b", classes.border, "py-2.5 px-4 relative"]}
  >
    <div class="max-w-7xl mx-auto flex items-center justify-center">
      <p class:list={[classes.text, "text-sm text-center pr-8"]}>
        {announcement.message}
      </p>
      <button
        id="dismiss-announcement"
        type="button"
        class:list={["absolute right-4 top-1/2 -translate-y-1/2 transition-colors p-1", classes.dismiss]}
        aria-label="Dismiss announcement"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </button>
    </div>
  </div>
)}

<script>
  // Handle announcement bar dismiss functionality
  document.addEventListener('DOMContentLoaded', () => {
    const bar = document.getElementById('announcement-bar');
    const dismissBtn = document.getElementById('dismiss-announcement');

    if (!bar || !dismissBtn) return;

    const messageHash = bar.dataset.hash;
    const storageKey = `announcement_dismissed_${messageHash}`;

    // Check if this specific announcement was dismissed
    if (localStorage.getItem(storageKey) === 'true') {
      bar.style.display = 'none';
      return;
    }

    // Handle dismiss click
    dismissBtn.addEventListener('click', () => {
      bar.style.display = 'none';
      localStorage.setItem(storageKey, 'true');
    });
  });
</script>
