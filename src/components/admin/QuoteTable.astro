---
/**
 * QuoteTable Component
 * Main data table for displaying quote requests
 * Supports sorting, filtering, inline editing, and row selection
 */
---

<div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
  <!-- Table Header with Search -->
  <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between gap-4 bg-gradient-to-r from-white to-mint-50/30">
    <div class="relative flex-1 max-w-md">
      <input
        type="text"
        id="quote-search"
        placeholder="Search quotes..."
        data-i18n-placeholder="searchQuotes"
        class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors bg-white"
      />
      <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <div class="text-sm text-gray-500 bg-white px-3 py-1.5 rounded-lg border border-gray-100">
      <span id="visible-count" class="font-semibold text-primary">0</span> <span data-i18n="quotes">quotes</span>
    </div>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" data-sort="created">
            <div class="flex items-center gap-1">
              <span data-i18n="created">Created</span>
              <svg class="w-3 h-3 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </div>
          </th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" data-sort="name">
            <div class="flex items-center gap-1">
              <span data-i18n="name">Name</span>
              <svg class="w-3 h-3 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </div>
          </th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" data-sort="status">
            <div class="flex items-center gap-1">
              <span data-i18n="stage">Stage</span>
              <svg class="w-3 h-3 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </div>
          </th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
            <span data-i18n="formula">Formula</span>
          </th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" data-sort="ourCost">
            <div class="flex items-center gap-1">
              <span data-i18n="price">Price</span>
              <svg class="w-3 h-3 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </div>
          </th>
          <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider cursor-pointer hover:text-gray-700" data-sort="orderQuantity">
            <div class="flex items-center gap-1">
              <span data-i18n="qty">Qty</span>
              <svg class="w-3 h-3 sort-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
              </svg>
            </div>
          </th>
          <th class="w-20 px-4 py-3"></th>
        </tr>
      </thead>
      <tbody id="quote-table-body" class="divide-y divide-gray-100">
        <!-- Rows will be inserted here by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Empty search results -->
  <div id="no-results" class="hidden py-12 text-center">
    <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <p class="text-gray-500" data-i18n="noMatchingQuotes">No quotes match your search</p>
  </div>
</div>

<style>
  /* Row hover effect - mint tint */
  tbody tr {
    transition: background-color 0.15s ease;
  }
  tbody tr:hover {
    background-color: #f0fef4;
  }

  /* Sort icon active state - primary mint */
  th[data-sort].sort-asc .sort-icon,
  th[data-sort].sort-desc .sort-icon {
    color: #00c16e;
  }
  th[data-sort]:hover {
    color: #00c16e;
  }

  /* Status badge styles */
  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    /* Default colors - will be overridden by inline styles */
    background-color: #f3f4f6;
    color: #374151;
  }
  .status-badge:hover {
    filter: brightness(0.95);
  }

  /* Product pill styles */
  .product-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.125rem 0.5rem;
    background-color: #f3f4f6;
    border-radius: 9999px;
    font-size: 0.75rem;
    color: #4b5563;
    white-space: nowrap;
  }
  .product-pill.more {
    background-color: #e5e7eb;
    color: #6b7280;
  }

  /* Inline editable input styles - mint theme */
  .inline-input {
    width: 80px;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
    border: 1px solid transparent;
    border-radius: 0.5rem;
    background-color: transparent;
    transition: all 0.15s ease;
    text-align: right;
  }
  .inline-input:hover {
    background-color: #f0fef4;
    border-color: #d1fae5;
  }
  .inline-input:focus {
    outline: none;
    background-color: white;
    border-color: #00c16e;
    box-shadow: 0 0 0 3px rgba(0, 193, 110, 0.15);
  }
  .inline-input.saving {
    background-color: #fef3c7;
    border-color: #fcd34d;
  }
  .inline-input.saved {
    background-color: #d1fae5;
    border-color: #00c16e;
  }
  .inline-input::placeholder {
    color: #9ca3af;
  }

  /* Price input with dollar sign */
  .price-cell {
    position: relative;
  }
  .price-cell::before {
    content: '$';
    position: absolute;
    left: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.875rem;
    pointer-events: none;
  }
  .price-cell .inline-input {
    padding-left: 1rem;
  }

  /* Hide number input spinners */
  .inline-input::-webkit-outer-spin-button,
  .inline-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .inline-input[type=number] {
    -moz-appearance: textfield;
  }

  /* Quantity input - narrower for 5 digits max */
  .qty-input {
    width: 60px;
  }

  /* Formula thumbnail styles */
  .formula-thumbnail {
    width: 40px;
    height: 40px;
  }
  .formula-thumbnail img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 0.5rem;
    border: 1px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .formula-thumbnail img:hover {
    border-color: #00c16e;
    box-shadow: 0 0 0 2px rgba(0, 193, 110, 0.15);
    transform: scale(1.05);
  }
  .formula-thumbnail .pdf-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s ease;
  }
  .formula-thumbnail .pdf-icon:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
  }
  .formula-thumbnail .pdf-icon span {
    color: white;
    font-size: 0.65rem;
    font-weight: 700;
    letter-spacing: 0.025em;
  }
  .formula-thumbnail .no-doc {
    width: 40px;
    height: 40px;
    background-color: #f3f4f6;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #9ca3af;
  }
</style>

<script>
  import { t, getStageLabel as i18nGetStageLabel, formatRelativeDate as i18nFormatRelativeDate, getLanguage } from '../../utils/i18n';

  // Quote data store
  let allQuotes: any[] = [];
  let filteredQuotes: any[] = [];
  let currentSort = { field: 'created', direction: 'desc' };
  let searchQuery = '';

  // Elements
  const tableBody = document.getElementById('quote-table-body');
  const searchInput = document.getElementById('quote-search') as HTMLInputElement;
  const visibleCount = document.getElementById('visible-count');
  const noResults = document.getElementById('no-results');

  // Listen for quotes data
  window.addEventListener('quotesLoaded', (e: Event) => {
    const event = e as CustomEvent;
    allQuotes = event.detail.quotes || [];
    applyFiltersAndRender();
  });

  // Listen for status filter changes
  window.addEventListener('statusFilterChanged', (e: Event) => {
    const event = e as CustomEvent;
    applyFiltersAndRender();
  });

  // Listen for quote updates (from inline edits or side panel)
  window.addEventListener('quoteUpdated', (e: Event) => {
    const event = e as CustomEvent;
    const updatedQuote = event.detail?.quote;
    if (!updatedQuote) return;

    // Update the quote in allQuotes array
    const index = allQuotes.findIndex(q => q.id === updatedQuote.id);
    if (index !== -1) {
      allQuotes[index] = { ...allQuotes[index], ...updatedQuote };
    }

    // Update the specific row's inputs without full re-render
    const row = document.querySelector(`tr[data-quote-id="${updatedQuote.id}"]`);
    if (row) {
      const priceInput = row.querySelector('.price-input') as HTMLInputElement;
      const qtyInput = row.querySelector('.qty-input') as HTMLInputElement;

      if (priceInput && updatedQuote.ourCost !== undefined) {
        priceInput.value = updatedQuote.ourCost != null && updatedQuote.ourCost !== 0
          ? formatPrice(updatedQuote.ourCost)
          : '';
      }
      if (qtyInput && updatedQuote.orderQuantity !== undefined) {
        qtyInput.value = updatedQuote.orderQuantity != null && updatedQuote.orderQuantity !== 0
          ? String(updatedQuote.orderQuantity)
          : '';
      }
    }
  });

  // Search input handler
  searchInput?.addEventListener('input', (e) => {
    searchQuery = (e.target as HTMLInputElement).value.toLowerCase();
    applyFiltersAndRender();
  });

  // Sort handlers
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.getAttribute('data-sort');
      if (!field) return;

      // Toggle direction if same field
      if (currentSort.field === field) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.field = field;
        currentSort.direction = 'asc';
      }

      // Update UI
      document.querySelectorAll('th[data-sort]').forEach(t => {
        t.classList.remove('sort-asc', 'sort-desc');
      });
      th.classList.add(`sort-${currentSort.direction}`);

      applyFiltersAndRender();
    });
  });

  // Apply filters, sorting, and render
  function applyFiltersAndRender() {
    const statusFilter = (window as any).getStatusFilter?.() || 'all';

    // Filter by status
    filteredQuotes = allQuotes.filter(quote => {
      if (statusFilter !== 'all' && quote.status !== statusFilter) return false;

      // Filter by search query
      if (searchQuery) {
        const searchableText = [
          quote.name,
        ].join(' ').toLowerCase();

        if (!searchableText.includes(searchQuery)) return false;
      }

      return true;
    });

    // Sort
    filteredQuotes.sort((a, b) => {
      let aVal, bVal;

      switch (currentSort.field) {
        case 'name':
          aVal = a.name?.toLowerCase() || '';
          bVal = b.name?.toLowerCase() || '';
          break;
        case 'status':
          aVal = a.status || '';
          bVal = b.status || '';
          break;
        case 'ourCost':
          aVal = a.ourCost || 0;
          bVal = b.ourCost || 0;
          break;
        case 'orderQuantity':
          aVal = a.orderQuantity || 0;
          bVal = b.orderQuantity || 0;
          break;
        case 'created':
        default:
          aVal = new Date(a.createdAt || 0).getTime();
          bVal = new Date(b.createdAt || 0).getTime();
          break;
      }

      if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
      return 0;
    });

    renderTable();
  }

  // Render table rows
  function renderTable() {
    // Re-find tableBody in case it wasn't available at script initialization
    const tbody = tableBody || document.getElementById('quote-table-body');
    if (!tbody) {
      console.error('QuoteTable: Cannot find table body element');
      return;
    }

    // Update count
    if (visibleCount) {
      visibleCount.textContent = String(filteredQuotes.length);
    }

    // Show/hide no results
    if (filteredQuotes.length === 0) {
      tbody.innerHTML = '';
      noResults?.classList.remove('hidden');
      return;
    }

    noResults?.classList.add('hidden');

    // Render rows
    const unnamedText = t('unnamed');
    const viewDetailsText = t('viewDetails');

    tbody.innerHTML = filteredQuotes.map(quote => {
      const createdDate = quote.createdAt
        ? formatRelativeDate(new Date(quote.createdAt))
        : 'â€”';

      const statusLabel = getStatusLabel(quote.status);
      const statusColor = getStatusBadgeColor(quote.status);
      const priceValue = quote.ourCost ? formatPrice(quote.ourCost) : '';
      const qtyValue = quote.orderQuantity || '';

      return `
        <tr data-quote-id="${quote.id}" class="cursor-pointer">
          <td class="px-4 py-3 text-gray-500 text-sm">
            ${createdDate}
          </td>
          <td class="px-4 py-3">
            <div class="font-medium text-gray-900">${escapeHtml(quote.name || unnamedText)}</div>
          </td>
          <td class="px-4 py-3">
            <span class="status-badge" data-quote-id="${quote.id}" style="background-color: ${statusColor.bg}; color: ${statusColor.text};">
              ${statusLabel}
            </span>
          </td>
          <td class="px-4 py-3">
            <div class="formula-thumbnail" data-quote-id="${quote.id}" onclick="event.stopPropagation()">
              <div class="formula-loading w-10 h-10 bg-gray-100 rounded-lg animate-pulse"></div>
            </div>
          </td>
          <td class="px-4 py-3">
            <div class="price-cell inline-block">
              <input
                type="text"
                class="inline-input price-input"
                data-quote-id="${quote.id}"
                data-field="ourCost"
                value="${priceValue}"
                placeholder="0.00"
                onclick="event.stopPropagation()"
              />
            </div>
          </td>
          <td class="px-4 py-3">
            <input
              type="number"
              class="inline-input qty-input"
              data-quote-id="${quote.id}"
              data-field="orderQuantity"
              value="${qtyValue}"
              placeholder="0"
              min="0"
              onclick="event.stopPropagation()"
            />
          </td>
          <td class="px-4 py-3">
            <button
              type="button"
              class="view-quote-btn p-2 text-gray-400 hover:text-primary hover:bg-gray-100 rounded-lg transition-colors"
              data-quote-id="${quote.id}"
              title="${viewDetailsText}"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </td>
        </tr>
      `;
    }).join('');

    // Add row click handlers
    tbody.querySelectorAll('tr[data-quote-id]').forEach(row => {
      row.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        // Don't open panel if clicking status badge or inline inputs
        if (target.closest('.status-badge') || target.closest('.inline-input')) return;

        const quoteId = row.getAttribute('data-quote-id');
        if (quoteId) {
          openQuotePanel(quoteId);
        }
      });
    });

    // Add status badge click handlers (for inline status change)
    tbody.querySelectorAll('.status-badge').forEach(badge => {
      badge.addEventListener('click', (e) => {
        e.stopPropagation();
        const quoteId = badge.getAttribute('data-quote-id');
        if (quoteId) {
          showStatusDropdown(badge as HTMLElement, quoteId);
        }
      });
    });

    // Add inline input handlers for price
    tbody.querySelectorAll('.price-input').forEach(input => {
      const inputEl = input as HTMLInputElement;

      inputEl.addEventListener('input', (e) => {
        // Format input - allow only numbers and decimal
        let value = inputEl.value.replace(/[^0-9.]/g, '');
        const parts = value.split('.');
        if (parts.length > 2) {
          value = parts[0] + '.' + parts.slice(1).join('');
        }
        if (parts[1]?.length > 2) {
          value = parts[0] + '.' + parts[1].slice(0, 2);
        }
        inputEl.value = value;
      });

      inputEl.addEventListener('blur', () => {
        const quoteId = inputEl.getAttribute('data-quote-id');
        const value = parseFloat(inputEl.value) || 0;
        inputEl.value = value ? formatPrice(value) : '';
        if (quoteId) {
          saveInlineField(quoteId, 'ourCost', value, inputEl);
        }
      });

      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inputEl.blur();
        }
      });
    });

    // Add inline input handlers for quantity
    tbody.querySelectorAll('.qty-input').forEach(input => {
      const inputEl = input as HTMLInputElement;

      inputEl.addEventListener('blur', () => {
        const quoteId = inputEl.getAttribute('data-quote-id');
        const value = parseInt(inputEl.value, 10) || 0;
        if (quoteId) {
          saveInlineField(quoteId, 'orderQuantity', value, inputEl);
        }
      });

      inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          inputEl.blur();
        }
      });
    });

    // Load formula thumbnails for all visible quotes
    loadFormulaThumbnails();
  }

  // Document cache to avoid re-fetching
  const documentCache: Map<string, any[]> = new Map();

  // Load formula thumbnails for visible quotes
  async function loadFormulaThumbnails() {
    const thumbnails = document.querySelectorAll('.formula-thumbnail[data-quote-id]');

    for (const thumbnail of thumbnails) {
      const quoteId = thumbnail.getAttribute('data-quote-id');
      if (!quoteId) continue;

      // Check cache first
      if (documentCache.has(quoteId)) {
        renderThumbnail(thumbnail as HTMLElement, documentCache.get(quoteId)!, quoteId);
        continue;
      }

      try {
        const response = await fetch(`/api/admin/quotes/${quoteId}/documents`);
        if (response.ok) {
          const data = await response.json();
          const documents = data.documents || [];
          documentCache.set(quoteId, documents);
          renderThumbnail(thumbnail as HTMLElement, documents, quoteId);
        } else {
          renderThumbnail(thumbnail as HTMLElement, [], quoteId);
        }
      } catch (error) {
        console.error('Failed to load documents for quote:', quoteId, error);
        renderThumbnail(thumbnail as HTMLElement, [], quoteId);
      }
    }
  }

  // Render a single thumbnail
  function renderThumbnail(container: HTMLElement, documents: any[], quoteId: string) {
    if (documents.length === 0) {
      const noFormulaText = t('noFormulaUploaded');
      container.innerHTML = `
        <div class="no-doc" title="${noFormulaText}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
      `;
      return;
    }

    const doc = documents[0]; // Show first document
    const fileType = doc.file_type;

    if (fileType === 'application/pdf') {
      container.innerHTML = `
        <div class="pdf-icon" title="${escapeHtml(doc.file_name)}" data-doc-id="${doc.id}" data-quote-id="${quoteId}">
          <span>PDF</span>
        </div>
      `;
    } else {
      // For images, we need to get a signed URL
      container.innerHTML = `
        <div class="img-loading w-10 h-10 bg-gray-100 rounded-lg animate-pulse" data-doc-id="${doc.id}" data-quote-id="${quoteId}"></div>
      `;
      loadImageThumbnail(container, doc.id, quoteId, doc.file_name);
    }

    // Add click handler to open document
    container.addEventListener('click', async (e) => {
      e.stopPropagation();
      const docId = doc.id;
      await openDocument(quoteId, docId);
    });
  }

  // Load image thumbnail with signed URL
  async function loadImageThumbnail(container: HTMLElement, docId: string, quoteId: string, fileName: string) {
    try {
      const response = await fetch(`/api/admin/quotes/${quoteId}/documents/${docId}/url`);
      if (response.ok) {
        const data = await response.json();
        if (data.url) {
          container.innerHTML = `<img src="${data.url}" alt="${escapeHtml(fileName)}" title="${escapeHtml(fileName)}" />`;
        }
      }
    } catch (error) {
      console.error('Failed to load image thumbnail:', error);
      const failedText = t('failedToLoadImage');
      container.innerHTML = `
        <div class="no-doc" title="${failedText}">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
      `;
    }
  }

  // Open document in new tab
  async function openDocument(quoteId: string, docId: string) {
    try {
      const response = await fetch(`/api/admin/quotes/${quoteId}/documents/${docId}/url`);
      if (response.ok) {
        const data = await response.json();
        if (data.url) {
          window.open(data.url, '_blank');
        }
      }
    } catch (error) {
      console.error('Failed to open document:', error);
    }
  }

  // Save inline field with visual feedback
  async function saveInlineField(quoteId: string, field: string, value: number, inputEl: HTMLInputElement) {
    // Find quote and check if value changed
    const quote = allQuotes.find(q => q.id === quoteId);
    if (!quote) return;

    const oldValue = quote[field] || 0;
    if (oldValue === value) return; // No change

    // Show saving state
    inputEl.classList.add('saving');
    inputEl.classList.remove('saved');

    try {
      const response = await fetch(`/api/admin/quotes/${quoteId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [field]: value }),
      });

      if (!response.ok) throw new Error('Failed to save');

      // Update local data
      quote[field] = value;

      // Update the input value to reflect saved value
      if (field === 'ourCost') {
        inputEl.value = value ? formatPrice(value) : '';
      } else {
        inputEl.value = value ? String(value) : '';
      }

      // Show saved state
      inputEl.classList.remove('saving');
      inputEl.classList.add('saved');
      setTimeout(() => {
        inputEl.classList.remove('saved');
      }, 1500);

      // Notify panel if open - use different event name to avoid triggering our own listener
      window.dispatchEvent(new CustomEvent('quoteUpdatedFromTable', { detail: { quote } }));
    } catch (error) {
      console.error('Failed to save field:', error);
      inputEl.classList.remove('saving');
      // Revert value
      if (field === 'ourCost') {
        inputEl.value = oldValue ? formatPrice(oldValue) : '';
      } else {
        inputEl.value = oldValue ? String(oldValue) : '';
      }
    }
  }

  // Open quote detail panel
  function openQuotePanel(quoteId: string) {
    const quote = allQuotes.find(q => q.id === quoteId);
    if (quote) {
      window.dispatchEvent(new CustomEvent('openQuotePanel', { detail: { quote } }));
    }
  }

  // Show status dropdown
  function showStatusDropdown(badge: HTMLElement, quoteId: string) {
    // Remove any existing dropdown
    document.querySelector('.status-dropdown')?.remove();

    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown absolute z-50 bg-white border border-gray-200 rounded-lg shadow-lg py-1 min-w-[140px]';

    // Use only the allowed stages in pipeline order
    const allowedStages = ['planning', 'order_samples', 'client_review_samples', 'full_batch_order'];

    dropdown.innerHTML = allowedStages.map(status => {
      const label = getStatusLabel(status);
      const color = getStatusBadgeColor(status);
      return `
        <button
          type="button"
          class="status-option w-full px-4 py-2 text-left text-sm hover:bg-gray-100 transition-colors"
          data-status="${status}"
        >
          <span class="status-badge" style="background-color: ${color.bg}; color: ${color.text};">${label}</span>
        </button>
      `;
    }).join('');

    // Position dropdown
    const rect = badge.getBoundingClientRect();
    dropdown.style.position = 'fixed';
    dropdown.style.top = `${rect.bottom + 4}px`;
    dropdown.style.left = `${rect.left}px`;

    document.body.appendChild(dropdown);

    // Handle status selection
    dropdown.querySelectorAll('.status-option').forEach(opt => {
      opt.addEventListener('click', async () => {
        const newStatus = opt.getAttribute('data-status');
        if (newStatus) {
          await updateQuoteStatus(quoteId, newStatus);
        }
        dropdown.remove();
      });
    });

    // Close on click outside
    setTimeout(() => {
      document.addEventListener('click', function closeDropdown(e) {
        if (!dropdown.contains(e.target as Node)) {
          dropdown.remove();
          document.removeEventListener('click', closeDropdown);
        }
      });
    }, 0);
  }

  // Update quote status
  async function updateQuoteStatus(quoteId: string, status: string) {
    try {
      const response = await fetch(`/api/admin/quotes/${quoteId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });

      if (!response.ok) throw new Error('Failed to update');

      // Update local data
      const quote = allQuotes.find(q => q.id === quoteId);
      if (quote) {
        quote.status = status;
        applyFiltersAndRender();

        // Update status counts
        const statusCounts = allQuotes.reduce((acc, q) => {
          acc[q.status] = (acc[q.status] || 0) + 1;
          return acc;
        }, {} as Record<string, number>);

        window.dispatchEvent(new CustomEvent('quotesLoaded', {
          detail: { quotes: allQuotes, statusCounts }
        }));
      }
    } catch (error) {
      console.error('Failed to update status:', error);
      // Show error toast or notification
    }
  }

  // Fixed color assignments for each stage (for visual consistency)
  const stageColors: Record<string, { bg: string; text: string }> = {
    'planning': { bg: '#dbeafe', text: '#1d4ed8' },           // blue - Price Quote
    'order_samples': { bg: '#fef3c7', text: '#b45309' },      // yellow - Order Samples
    'client_review_samples': { bg: '#ede9fe', text: '#7c3aed' }, // purple - Sample Delivered
    'full_batch_order': { bg: '#d1fae5', text: '#047857' },   // green - Full Batch Order
  };

  // Get color for a status badge
  function getStatusBadgeColor(status: string): { bg: string; text: string } {
    return stageColors[status] || { bg: '#f3f4f6', text: '#374151' };
  }

  // Helper functions - use i18n
  function getStatusLabel(status: string): string {
    return i18nGetStageLabel(status);
  }

  function formatRelativeDate(date: Date): string {
    return i18nFormatRelativeDate(date);
  }

  function formatPrice(value: number): string {
    return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Update text elements with data-i18n attributes
  function updateI18nText() {
    // Update placeholder
    const searchEl = document.getElementById('quote-search') as HTMLInputElement;
    if (searchEl) {
      searchEl.placeholder = t('searchQuotes');
    }

    // Update data-i18n elements
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        el.textContent = t(key as any);
      }
    });
  }

  // Listen for language changes
  window.addEventListener('languageChanged', () => {
    // Update static text
    updateI18nText();

    // Re-render the table to update dynamic content
    applyFiltersAndRender();
  });
</script>
