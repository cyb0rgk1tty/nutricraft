---
/**
 * QuoteDetailPanel Component
 * Slide-out panel for viewing and editing quote details
 * Supports per-product pricing and notes with auto-save
 */
---

<!-- Backdrop -->
<div
  id="panel-backdrop"
  class="fixed inset-0 bg-black/40 z-[60] opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm"
  aria-hidden="true"
></div>

<!-- Panel -->
<aside
  id="quote-panel"
  class="fixed top-0 right-0 h-full w-full max-w-full sm:max-w-lg bg-white z-[70] shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col border-l border-gray-200"
  role="dialog"
  aria-modal="true"
  aria-label="Quote details"
  data-i18n-aria="quoteDetails"
>
  <!-- Header with gradient -->
  <div class="relative bg-gradient-to-r from-primary to-mint-500">
    <div class="flex items-center justify-between p-4 py-5">
      <div>
        <h2 id="panel-name" class="text-lg font-semibold text-white" data-i18n-default="productName">Product Name</h2>
        <p id="panel-id" class="text-xs text-white/70 font-mono" data-i18n-default="id">ID</p>
      </div>
      <button
        id="close-panel"
        type="button"
        aria-label="Close panel"
        data-i18n-aria="closePanel"
        class="p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Content (Scrollable) -->
  <div class="flex-1 overflow-y-auto">
    <!-- Status Section -->
    <div class="p-4 border-b border-gray-100">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3" data-i18n="stage">Stage</h3>
      <div class="grid grid-cols-2 sm:flex gap-2 sm:flex-wrap">
        <button type="button" class="status-btn" data-status="planning" data-i18n="priceQuote">Price Quote</button>
        <button type="button" class="status-btn" data-status="order_samples" data-i18n="orderSamples">Order Samples</button>
        <button type="button" class="status-btn" data-status="client_review_samples" data-i18n="sampleDelivered">Sample Delivered</button>
        <button type="button" class="status-btn" data-status="full_batch_order" data-i18n="fullBatchOrder">Full Batch Order</button>
      </div>
    </div>

    <!-- Product Details Section -->
    <div class="p-4 border-b border-gray-100">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3" data-i18n="productDetails">Product Details</h3>
      <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
        <div>
          <span class="text-gray-500 text-xs sm:text-sm" data-i18n="created">Created</span>
          <p id="panel-created" class="font-medium text-gray-900 text-sm">—</p>
        </div>
        <div>
          <span class="text-gray-500 text-xs sm:text-sm" data-i18n="updated">Updated</span>
          <p id="panel-updated" class="font-medium text-gray-900 text-sm">—</p>
        </div>
      </div>
    </div>

    <!-- Pricing & Quantity Section -->
    <div class="p-4 border-b border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider" data-i18n="pricingQuantity">Pricing & Quantity</h3>
        <div id="auto-save-indicator" class="text-xs text-gray-400 hidden">
          <span class="saving hidden" data-i18n="saving">Saving...</span>
          <span class="saved hidden text-green-600" data-i18n="saved">Saved</span>
        </div>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="price-input-wrapper">
          <label class="block text-sm text-gray-600 mb-2" data-i18n="price">Price</label>
          <input
            type="text"
            id="panel-our-cost-input"
            class="price-input w-full"
            placeholder="0.00"
          />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-2" data-i18n="orderQuantity">Order Quantity</label>
          <input
            type="number"
            id="panel-order-quantity-input"
            class="quantity-input w-full"
            placeholder="0"
            min="0"
            step="1"
          />
        </div>
      </div>
    </div>

    <!-- Public Notes Section (displayed on dashboard) -->
    <div class="p-4 border-b border-gray-100">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3" data-i18n="publicNotes">Public Notes</h3>
      <textarea
        id="panel-public-notes"
        placeholder="Add notes visible on the dashboard..."
        data-i18n-placeholder="addPublicNotesPlaceholder"
        rows="4"
        class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors resize-none"
      ></textarea>
    </div>

    <!-- Formula Documents Section -->
    <div class="p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider" data-i18n="formulaDocuments">Formula Documents</h3>
        <label class="cursor-pointer">
          <input type="file" id="doc-file-input" class="hidden" accept=".pdf,.png,.jpg,.jpeg" />
          <span class="px-3 py-1.5 text-xs font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors inline-flex items-center gap-1">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            <span data-i18n="upload">Upload</span>
          </span>
        </label>
      </div>

      <!-- Upload progress -->
      <div id="upload-progress" class="hidden mb-3">
        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
        </div>
        <p id="upload-status" class="text-xs text-gray-500 mt-1" data-i18n="uploading">Uploading...</p>
      </div>

      <!-- Document list -->
      <div id="documents-list" class="space-y-2">
        <!-- Documents rendered dynamically -->
      </div>

      <!-- Empty state -->
      <div id="documents-empty" class="text-center py-6 text-gray-400">
        <svg class="w-8 h-8 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        <p class="text-sm" data-i18n="noDocumentsUploaded">No documents uploaded</p>
      </div>

      <!-- Documents loading state -->
      <div id="documents-loading" class="hidden text-center py-6 text-gray-400">
        <svg class="w-6 h-6 mx-auto mb-2 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm" data-i18n="loadingDocuments">Loading documents...</p>
      </div>
    </div>
  </div>

  <!-- Document Viewer Overlay -->
  <div id="doc-viewer-overlay" class="fixed inset-0 bg-black/90 z-[80] hidden flex-col">
    <!-- Viewer Header -->
    <div class="flex items-center justify-between p-4 bg-black/50">
      <button id="viewer-back" type="button" class="text-white hover:text-gray-300 transition-colors flex items-center gap-2 text-sm">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        <span data-i18n="back">Back</span>
      </button>
      <div id="viewer-filename" class="text-white text-sm font-medium truncate max-w-[200px]"></div>
      <div class="flex items-center gap-2">
        <button id="viewer-download" type="button" class="text-white hover:text-gray-300 transition-colors p-2 rounded-lg hover:bg-white/10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
        </button>
        <button id="viewer-delete" type="button" class="text-red-400 hover:text-red-300 transition-colors p-2 rounded-lg hover:bg-white/10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Viewer Content -->
    <div id="viewer-content" class="flex-1 flex items-center justify-center overflow-auto p-4">
      <!-- PDF iframe or image will be inserted here -->
    </div>

    <!-- Image Zoom Controls (shown only for images) -->
    <div id="zoom-controls" class="hidden absolute bottom-4 sm:bottom-6 left-1/2 -translate-x-1/2 bg-black/70 rounded-full px-3 sm:px-4 py-2 flex items-center gap-2 sm:gap-3">
      <button id="zoom-out" type="button" class="text-white hover:text-gray-300 transition-colors w-10 h-10 sm:w-8 sm:h-8 flex items-center justify-center">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
        </svg>
      </button>
      <span id="zoom-level" class="text-white text-sm font-medium min-w-[50px] text-center">100%</span>
      <button id="zoom-in" type="button" class="text-white hover:text-gray-300 transition-colors w-10 h-10 sm:w-8 sm:h-8 flex items-center justify-center">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
      </button>
      <button id="zoom-reset" type="button" class="text-white hover:text-gray-300 transition-colors text-xs px-3 py-2 sm:px-2 sm:py-1 rounded hover:bg-white/10" data-i18n="reset">
        Reset
      </button>
    </div>
  </div>

  <!-- Footer -->
  <div class="p-4 border-t border-gray-100 bg-gray-50/80">
    <button
      id="panel-save-btn"
      type="button"
      class="w-full px-4 py-2.5 text-white bg-primary rounded-lg text-sm font-medium hover:bg-primary-dark transition-all shadow-sm hover:shadow flex items-center justify-center gap-2"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      <span data-i18n="saveChanges">Save Changes</span>
    </button>
    <p id="panel-sync-status" class="text-xs text-center text-gray-400 mt-2" data-i18n="lastSyncedNever">Last synced: Never</p>
  </div>
</aside>

<style>
  /* Panel open state */
  #quote-panel.panel-open {
    transform: translateX(0);
  }

  #panel-backdrop.backdrop-visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Status buttons */
  .status-btn {
    padding: 0.625rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    background-color: #f3f4f6;
    color: #6b7280;
    border: 2px solid transparent;
    transition: all 0.15s ease;
    min-height: 44px;
    text-align: center;
  }

  @media (min-width: 640px) {
    .status-btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }
  }

  .status-btn:hover {
    background-color: #e5e7eb;
  }

  .status-btn.active {
    border-color: currentColor;
  }

  .status-btn[data-status="planning"].active { background-color: #dbeafe; color: #1d4ed8; }
  .status-btn[data-status="order_samples"].active { background-color: #fef3c7; color: #b45309; }
  .status-btn[data-status="client_review_samples"].active { background-color: #ede9fe; color: #7c3aed; }
  .status-btn[data-status="full_batch_order"].active { background-color: #d1fae5; color: #047857; }

  /* Product card */
  .product-card {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    transition: border-color 0.15s ease;
  }

  .product-card:focus-within {
    border-color: #00c16e;
  }

  /* Price input */
  .price-input {
    width: 100%;
    padding: 0.75rem 0.75rem;
    padding-left: 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    text-align: right;
    transition: all 0.15s ease;
    min-height: 48px;
  }

  @media (min-width: 640px) {
    .price-input {
      width: 120px;
      padding: 0.5rem 0.75rem;
      padding-left: 1.5rem;
      font-size: 0.875rem;
      min-height: auto;
    }
  }

  .price-input:focus {
    outline: none;
    border-color: #00c16e;
    box-shadow: 0 0 0 3px rgba(0, 193, 110, 0.1);
  }

  .price-input-wrapper {
    position: relative;
  }

  .price-input-wrapper::before {
    content: '$';
    position: absolute;
    left: 0.75rem;
    bottom: 0.625rem;
    color: #6b7280;
    font-size: 0.875rem;
    pointer-events: none;
  }

  /* Quantity input */
  .quantity-input {
    padding: 0.75rem 0.75rem;
    font-size: 1rem;
    font-weight: 500;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    transition: all 0.15s ease;
    min-height: 48px;
  }

  @media (min-width: 640px) {
    .quantity-input {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      min-height: auto;
    }
  }

  .quantity-input:focus {
    outline: none;
    border-color: #00c16e;
    box-shadow: 0 0 0 3px rgba(0, 193, 110, 0.1);
  }

  /* Hide number input spinners */
  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .quantity-input[type=number] {
    -moz-appearance: textfield;
  }

  /* Scrollbar */
  #quote-panel ::-webkit-scrollbar {
    width: 6px;
  }

  #quote-panel ::-webkit-scrollbar-track {
    background: transparent;
  }

  #quote-panel ::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    border-radius: 3px;
  }

  #quote-panel ::-webkit-scrollbar-thumb:hover {
    background-color: #9ca3af;
  }

  /* Document item card */
  .doc-item {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: border-color 0.15s ease;
  }

  .doc-item:hover {
    border-color: #d1d5db;
  }

  .doc-item-icon {
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 0.5rem;
    flex-shrink: 0;
  }

  .doc-item-icon.pdf {
    background-color: #fee2e2;
    color: #dc2626;
  }

  .doc-item-icon.image {
    background-color: #dbeafe;
    color: #2563eb;
  }

  .doc-item-info {
    flex: 1;
    min-width: 0;
  }

  .doc-item-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .doc-item-meta {
    font-size: 0.75rem;
    color: #9ca3af;
    margin-top: 0.125rem;
  }

  .doc-item-actions {
    display: flex;
    gap: 0.25rem;
  }

  .doc-item-btn {
    padding: 0.375rem;
    border-radius: 0.375rem;
    color: #6b7280;
    transition: all 0.15s ease;
  }

  .doc-item-btn:hover {
    background-color: #e5e7eb;
    color: #374151;
  }

  .doc-item-btn.delete:hover {
    background-color: #fee2e2;
    color: #dc2626;
  }

  /* Document viewer overlay */
  #doc-viewer-overlay.visible {
    display: flex;
  }

  #viewer-content iframe {
    width: 100%;
    height: 100%;
    border: none;
    border-radius: 0.5rem;
    background: white;
  }

  #viewer-content img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transition: transform 0.2s ease;
  }
</style>

<script>
  import { t, formatRelativeTime as i18nFormatRelativeTime, getLanguage } from '../../utils/i18n';

  // Current quote data
  let currentQuote: any = null;
  let saveTimeout: ReturnType<typeof setTimeout> | null = null;

  // Elements
  const panel = document.getElementById('quote-panel');
  const backdrop = document.getElementById('panel-backdrop');
  const closeBtn = document.getElementById('close-panel');
  const saveBtn = document.getElementById('panel-save-btn');
  const publicNotesTextarea = document.getElementById('panel-public-notes') as HTMLTextAreaElement;
  const ourCostInput = document.getElementById('panel-our-cost-input') as HTMLInputElement;
  const orderQuantityInput = document.getElementById('panel-order-quantity-input') as HTMLInputElement;
  const autoSaveIndicator = document.getElementById('auto-save-indicator');

  // Open panel
  function openPanel() {
    panel?.classList.add('panel-open');
    backdrop?.classList.add('backdrop-visible');
    document.body.style.overflow = 'hidden';
  }

  // Close panel
  function closePanel() {
    panel?.classList.remove('panel-open');
    backdrop?.classList.remove('backdrop-visible');
    document.body.style.overflow = '';
    currentQuote = null;
  }

  // Populate panel with quote data
  function populatePanel(quote: any) {
    currentQuote = quote;

    // Get locale for date formatting
    const lang = getLanguage();
    const locale = lang === 'zh' ? 'zh-CN' : 'en-US';

    // Basic info
    const nameEl = document.getElementById('panel-name');
    const idEl = document.getElementById('panel-id');
    const created = document.getElementById('panel-created');
    const updated = document.getElementById('panel-updated');

    if (nameEl) nameEl.textContent = quote.name || t('unnamed');
    if (idEl) idEl.textContent = quote.id || '';
    if (created) {
      created.textContent = quote.createdAt
        ? new Date(quote.createdAt).toLocaleDateString(locale, {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })
        : '—';
    }
    if (updated) {
      updated.textContent = quote.updatedAt
        ? new Date(quote.updatedAt).toLocaleDateString(locale, {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })
        : '—';
    }

    // Status
    document.querySelectorAll('.status-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-status') === quote.status) {
        btn.classList.add('active');
      }
    });

    // Our Cost
    if (ourCostInput) {
      ourCostInput.value = quote.ourCost ? formatPrice(quote.ourCost) : '';
    }

    // Order Quantity
    if (orderQuantityInput) {
      orderQuantityInput.value = quote.orderQuantity ? String(quote.orderQuantity) : '';
    }

    // Public Notes
    if (publicNotesTextarea) {
      publicNotesTextarea.value = quote.publicNotes || '';
    }

    // Sync status
    const syncStatus = document.getElementById('panel-sync-status');
    if (syncStatus) {
      if (quote.lastSyncedAt) {
        syncStatus.textContent = t('lastSynced', { time: formatRelativeTime(new Date(quote.lastSyncedAt)) });
      } else {
        syncStatus.textContent = t('lastSyncedNever');
      }
    }

    openPanel();
  }

  // Our Cost input handler
  ourCostInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;

    // Format input as currency
    let value = target.value.replace(/[^0-9.]/g, '');
    const parts = value.split('.');
    if (parts.length > 2) {
      value = parts[0] + '.' + parts.slice(1).join('');
    }
    if (parts[1]?.length > 2) {
      value = parts[0] + '.' + parts[1].slice(0, 2);
    }
    target.value = value;

    // Update quote ourCost
    if (currentQuote) {
      currentQuote.ourCost = parseFloat(value) || 0;
      scheduleAutoSave();
    }
  });

  ourCostInput?.addEventListener('blur', (e) => {
    const target = e.target as HTMLInputElement;
    const value = parseFloat(target.value) || 0;
    target.value = value ? formatPrice(value) : '';
  });

  // Order Quantity input handler
  orderQuantityInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    const value = parseInt(target.value, 10) || 0;

    // Update quote orderQuantity
    if (currentQuote) {
      currentQuote.orderQuantity = value;
      scheduleAutoSave();
    }
  });

  // Schedule auto-save with debounce
  function scheduleAutoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);

    showSaveIndicator('saving');

    saveTimeout = setTimeout(async () => {
      await saveQuote();
    }, 500);
  }

  // Show save indicator
  function showSaveIndicator(state: 'saving' | 'saved') {
    if (!autoSaveIndicator) return;

    autoSaveIndicator.classList.remove('hidden');
    const saving = autoSaveIndicator.querySelector('.saving');
    const saved = autoSaveIndicator.querySelector('.saved');

    if (state === 'saving') {
      saving?.classList.remove('hidden');
      saved?.classList.add('hidden');
    } else {
      saving?.classList.add('hidden');
      saved?.classList.remove('hidden');
      setTimeout(() => {
        autoSaveIndicator.classList.add('hidden');
      }, 2000);
    }
  }

  // Save quote (used by auto-save for individual field changes)
  async function saveQuote() {
    if (!currentQuote) return;

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: currentQuote.status,
          ourCost: currentQuote.ourCost,
          orderQuantity: currentQuote.orderQuantity,
          publicNotes: currentQuote.publicNotes,
        }),
      });

      if (!response.ok) throw new Error('Failed to save');

      showSaveIndicator('saved');

      // Update table
      window.dispatchEvent(new CustomEvent('quoteUpdated', { detail: { quote: currentQuote } }));
    } catch (error) {
      console.error('Failed to save quote:', error);
    }
  }

  // Save and sync to CRM (main save button)
  async function saveAndSync() {
    if (!currentQuote) return;

    const btn = saveBtn;
    if (btn) {
      btn.setAttribute('disabled', 'true');
      btn.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        <span>${t('saving')}</span>
      `;
    }

    try {
      // First save locally
      const saveResponse = await fetch(`/api/admin/quotes/${currentQuote.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: currentQuote.status,
          ourCost: currentQuote.ourCost,
          orderQuantity: currentQuote.orderQuantity,
          publicNotes: currentQuote.publicNotes,
        }),
      });

      if (!saveResponse.ok) throw new Error('Failed to save');

      // Update table
      window.dispatchEvent(new CustomEvent('quoteUpdated', { detail: { quote: currentQuote } }));

      // Then sync to CRM
      const syncResponse = await fetch(`/api/admin/quotes/${currentQuote.id}/sync`, {
        method: 'POST',
      });

      if (!syncResponse.ok) throw new Error('Sync failed');

      // Update sync status
      const syncStatus = document.getElementById('panel-sync-status');
      if (syncStatus) {
        syncStatus.textContent = t('lastSyncedJustNow');
      }

      currentQuote.lastSyncedAt = new Date().toISOString();
    } catch (error) {
      console.error('Failed to save and sync:', error);
    } finally {
      if (btn) {
        btn.removeAttribute('disabled');
        btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          <span>${t('saveChanges')}</span>
        `;
      }
    }
  }

  // Event listeners
  closeBtn?.addEventListener('click', closePanel);
  backdrop?.addEventListener('click', closePanel);
  saveBtn?.addEventListener('click', saveAndSync);

  // Status button handlers
  document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const status = btn.getAttribute('data-status');
      if (!status || !currentQuote) return;

      // Update UI
      document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update data
      currentQuote.status = status;
      scheduleAutoSave();
    });
  });

  // Public Notes auto-save
  publicNotesTextarea?.addEventListener('input', () => {
    if (currentQuote) {
      currentQuote.publicNotes = publicNotesTextarea.value;
    }
    scheduleAutoSave();
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && panel?.classList.contains('panel-open')) {
      closePanel();
    }
  });

  // Listen for open panel event
  window.addEventListener('openQuotePanel', (e: Event) => {
    const event = e as CustomEvent;
    populatePanel(event.detail.quote);
  });

  // Helper functions
  function formatPrice(value: number): string {
    return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatRelativeTime(date: Date): string {
    return i18nFormatRelativeTime(date);
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // =============================================================================
  // DOCUMENT MANAGEMENT
  // =============================================================================

  interface QuoteDocument {
    id: string;
    crm_product_id: string;
    file_name: string;
    file_type: string;
    file_size: number;
    storage_path: string;
    description: string | null;
    created_at: string;
    updated_at: string;
  }

  let currentDocuments: QuoteDocument[] = [];
  let currentViewingDoc: QuoteDocument | null = null;
  let currentZoom = 100;

  // Document elements
  const docFileInput = document.getElementById('doc-file-input') as HTMLInputElement;
  const uploadProgress = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const uploadStatus = document.getElementById('upload-status');
  const documentsList = document.getElementById('documents-list');
  const documentsEmpty = document.getElementById('documents-empty');
  const documentsLoading = document.getElementById('documents-loading');

  // Viewer elements
  const viewerOverlay = document.getElementById('doc-viewer-overlay');
  const viewerContent = document.getElementById('viewer-content');
  const viewerFilename = document.getElementById('viewer-filename');
  const viewerBack = document.getElementById('viewer-back');
  const viewerDownload = document.getElementById('viewer-download');
  const viewerDelete = document.getElementById('viewer-delete');
  const zoomControls = document.getElementById('zoom-controls');
  const zoomLevel = document.getElementById('zoom-level');
  const zoomIn = document.getElementById('zoom-in');
  const zoomOut = document.getElementById('zoom-out');
  const zoomReset = document.getElementById('zoom-reset');

  // Load documents for current quote
  async function loadDocuments() {
    if (!currentQuote) return;

    documentsList?.classList.add('hidden');
    documentsEmpty?.classList.add('hidden');
    documentsLoading?.classList.remove('hidden');

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/documents`);
      const data = await response.json();

      if (data.success) {
        currentDocuments = data.documents;
        renderDocumentsList();
      } else {
        console.error('Failed to load documents:', data.error);
        currentDocuments = [];
        renderDocumentsList();
      }
    } catch (error) {
      console.error('Failed to load documents:', error);
      currentDocuments = [];
      renderDocumentsList();
    } finally {
      documentsLoading?.classList.add('hidden');
    }
  }

  // Render documents list
  function renderDocumentsList() {
    if (!documentsList || !documentsEmpty) return;

    if (currentDocuments.length === 0) {
      documentsList.classList.add('hidden');
      documentsEmpty.classList.remove('hidden');
      return;
    }

    documentsEmpty.classList.add('hidden');
    documentsList.classList.remove('hidden');
    documentsList.innerHTML = currentDocuments.map(doc => {
      const isPdf = doc.file_type === 'application/pdf';
      const iconClass = isPdf ? 'pdf' : 'image';
      const icon = isPdf
        ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>`
        : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`;

      const fileSize = formatFileSize(doc.file_size);
      const uploadTime = formatRelativeTime(new Date(doc.created_at));

      const viewText = t('view');
      const deleteText = t('delete');

      return `
        <div class="doc-item" data-doc-id="${doc.id}">
          <div class="doc-item-icon ${iconClass}">${icon}</div>
          <div class="doc-item-info">
            <div class="doc-item-name" title="${escapeHtml(doc.file_name)}">${escapeHtml(doc.file_name)}</div>
            <div class="doc-item-meta">${fileSize} &bull; ${uploadTime}</div>
          </div>
          <div class="doc-item-actions">
            <button type="button" class="doc-item-btn view-doc" data-doc-id="${doc.id}" title="${viewText}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
            </button>
            <button type="button" class="doc-item-btn delete" data-doc-id="${doc.id}" title="${deleteText}">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </div>
      `;
    }).join('');

    // Add event listeners
    documentsList.querySelectorAll('.view-doc').forEach(btn => {
      btn.addEventListener('click', () => {
        const docId = btn.getAttribute('data-doc-id');
        if (docId) viewDocument(docId);
      });
    });

    documentsList.querySelectorAll('.doc-item-btn.delete').forEach(btn => {
      btn.addEventListener('click', () => {
        const docId = btn.getAttribute('data-doc-id');
        if (docId) confirmDeleteDocument(docId);
      });
    });
  }

  // Format file size
  function formatFileSize(bytes: number): string {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  }

  // Upload document
  async function uploadDocument(file: File) {
    if (!currentQuote) return;

    // Validate file size
    if (file.size > 10 * 1024 * 1024) {
      alert(t('fileSizeExceeds'));
      return;
    }

    // Validate file type
    const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg'];
    if (!allowedTypes.includes(file.type)) {
      alert(t('invalidFileType'));
      return;
    }

    // Show progress
    uploadProgress?.classList.remove('hidden');
    if (progressBar) progressBar.style.width = '0%';
    if (uploadStatus) uploadStatus.textContent = t('uploading');

    try {
      const formData = new FormData();
      formData.append('file', file);

      // Simulate progress (actual progress would require XHR)
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        if (progressBar && progress < 90) {
          progressBar.style.width = `${progress}%`;
        }
      }, 100);

      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/documents`, {
        method: 'POST',
        body: formData,
      });

      clearInterval(progressInterval);

      if (progressBar) progressBar.style.width = '100%';

      const data = await response.json();

      if (data.success) {
        if (uploadStatus) uploadStatus.textContent = t('uploadComplete');
        setTimeout(() => {
          uploadProgress?.classList.add('hidden');
        }, 1000);
        // Refresh documents list
        loadDocuments();
      } else {
        if (uploadStatus) uploadStatus.textContent = t('error', { message: data.error });
        setTimeout(() => {
          uploadProgress?.classList.add('hidden');
        }, 3000);
      }
    } catch (error) {
      console.error('Upload failed:', error);
      if (uploadStatus) uploadStatus.textContent = t('uploadFailed');
      setTimeout(() => {
        uploadProgress?.classList.add('hidden');
      }, 3000);
    }

    // Clear input
    if (docFileInput) docFileInput.value = '';
  }

  // View document
  async function viewDocument(docId: string) {
    const doc = currentDocuments.find(d => d.id === docId);
    if (!doc || !currentQuote) return;

    currentViewingDoc = doc;

    try {
      // Get signed URL
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/documents/${docId}/url`);
      const data = await response.json();

      if (!data.success) {
        alert(t('failedToLoadDoc'));
        return;
      }

      // Set filename
      if (viewerFilename) viewerFilename.textContent = doc.file_name;

      // Clear previous content
      if (viewerContent) viewerContent.innerHTML = '';

      // Show appropriate viewer
      if (doc.file_type === 'application/pdf') {
        // PDF viewer
        const iframe = document.createElement('iframe');
        iframe.src = data.url;
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        viewerContent?.appendChild(iframe);
        zoomControls?.classList.add('hidden');
      } else {
        // Image viewer
        const img = document.createElement('img');
        img.src = data.url;
        img.alt = doc.file_name;
        img.id = 'viewer-image';
        viewerContent?.appendChild(img);
        zoomControls?.classList.remove('hidden');
        currentZoom = 100;
        updateZoomLevel();
      }

      // Show overlay
      viewerOverlay?.classList.remove('hidden');
      viewerOverlay?.classList.add('visible');
    } catch (error) {
      console.error('Failed to view document:', error);
      alert(t('failedToLoadDoc'));
    }
  }

  // Close viewer
  function closeViewer() {
    viewerOverlay?.classList.add('hidden');
    viewerOverlay?.classList.remove('visible');
    if (viewerContent) viewerContent.innerHTML = '';
    currentViewingDoc = null;
    currentZoom = 100;
  }

  // Zoom functions
  function updateZoomLevel() {
    if (zoomLevel) zoomLevel.textContent = `${currentZoom}%`;
    const img = document.getElementById('viewer-image') as HTMLImageElement;
    if (img) {
      img.style.transform = `scale(${currentZoom / 100})`;
    }
  }

  function doZoomIn() {
    currentZoom = Math.min(currentZoom + 25, 300);
    updateZoomLevel();
  }

  function doZoomOut() {
    currentZoom = Math.max(currentZoom - 25, 25);
    updateZoomLevel();
  }

  function doZoomReset() {
    currentZoom = 100;
    updateZoomLevel();
  }

  // Download document
  async function downloadDocument() {
    if (!currentViewingDoc || !currentQuote) return;

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/documents/${currentViewingDoc.id}/url`);
      const data = await response.json();

      if (data.success) {
        // Create temporary link and click it
        const a = document.createElement('a');
        a.href = data.url;
        a.download = currentViewingDoc.file_name;
        a.target = '_blank';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    } catch (error) {
      console.error('Download failed:', error);
      alert('Failed to download document');
    }
  }

  // Confirm delete
  function confirmDeleteDocument(docId: string) {
    const doc = currentDocuments.find(d => d.id === docId);
    if (!doc) return;

    if (confirm(t('confirmDelete', { filename: doc.file_name }))) {
      deleteDocument(docId);
    }
  }

  // Delete document
  async function deleteDocument(docId: string) {
    if (!currentQuote) return;

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/documents/${docId}`, {
        method: 'DELETE',
      });

      const data = await response.json();

      if (data.success) {
        // If we're viewing this document, close the viewer
        if (currentViewingDoc?.id === docId) {
          closeViewer();
        }
        // Refresh documents list
        loadDocuments();
      } else {
        alert(t('failedToDelete'));
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert(t('failedToDelete'));
    }
  }

  // Event listeners for documents
  docFileInput?.addEventListener('change', (e) => {
    const target = e.target as HTMLInputElement;
    const file = target.files?.[0];
    if (file) {
      uploadDocument(file);
    }
  });

  viewerBack?.addEventListener('click', closeViewer);
  viewerDownload?.addEventListener('click', downloadDocument);
  viewerDelete?.addEventListener('click', () => {
    if (currentViewingDoc) {
      confirmDeleteDocument(currentViewingDoc.id);
    }
  });

  zoomIn?.addEventListener('click', doZoomIn);
  zoomOut?.addEventListener('click', doZoomOut);
  zoomReset?.addEventListener('click', doZoomReset);

  // Close viewer on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && viewerOverlay?.classList.contains('visible')) {
      closeViewer();
    }
  });

  // Load documents when panel opens - modify existing openQuotePanel listener
  const originalPopulatePanel = populatePanel;
  populatePanel = function(quote: any) {
    originalPopulatePanel(quote);
    loadDocuments();
  };

  // Update all i18n elements in the panel
  function updatePanelI18n() {
    // Update data-i18n elements
    document.querySelectorAll('#quote-panel [data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        el.textContent = t(key as any);
      }
    });

    // Update placeholders
    document.querySelectorAll('#quote-panel [data-i18n-placeholder]').forEach(el => {
      const key = el.getAttribute('data-i18n-placeholder');
      if (key) {
        (el as HTMLInputElement | HTMLTextAreaElement).placeholder = t(key as any);
      }
    });

    // Update aria-labels
    document.querySelectorAll('#quote-panel [data-i18n-aria]').forEach(el => {
      const key = el.getAttribute('data-i18n-aria');
      if (key) {
        el.setAttribute('aria-label', t(key as any));
      }
    });
  }

  // Listen for language changes
  window.addEventListener('languageChanged', () => {
    updatePanelI18n();

    // If panel is open with a quote, re-populate to update date formatting
    if (currentQuote && panel?.classList.contains('panel-open')) {
      populatePanel(currentQuote);
    }
  });
</script>
