---
/**
 * QuoteDetailPanel Component
 * Slide-out panel for viewing and editing quote details
 * Supports per-product pricing and notes with auto-save
 */
---

<!-- Backdrop -->
<div
  id="panel-backdrop"
  class="fixed inset-0 bg-black/40 z-[60] opacity-0 pointer-events-none transition-opacity duration-300 backdrop-blur-sm"
  aria-hidden="true"
></div>

<!-- Panel -->
<aside
  id="quote-panel"
  class="fixed top-0 right-0 h-full w-full max-w-lg bg-white z-[70] shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col border-l border-gray-200"
  role="dialog"
  aria-modal="true"
  aria-label="Quote details"
>
  <!-- Header -->
  <div class="relative">
    <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-primary to-mint-400"></div>
    <div class="flex items-center justify-between p-4 pt-5 border-b border-gray-100">
      <div>
        <h2 id="panel-name" class="text-lg font-semibold text-gray-900">Product Name</h2>
        <p id="panel-id" class="text-xs text-gray-400 font-mono">ID</p>
      </div>
      <button
        id="close-panel"
        type="button"
        aria-label="Close panel"
        class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg transition-colors"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Content (Scrollable) -->
  <div class="flex-1 overflow-y-auto">
    <!-- Status Section -->
    <div class="p-4 border-b border-gray-100">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Status</h3>
      <div class="flex gap-2 flex-wrap">
        <button type="button" class="status-btn" data-status="new">New</button>
        <button type="button" class="status-btn" data-status="in_progress">In Progress</button>
        <button type="button" class="status-btn" data-status="sent">Quote Sent</button>
        <button type="button" class="status-btn" data-status="won">Won</button>
        <button type="button" class="status-btn" data-status="lost">Lost</button>
      </div>
    </div>

    <!-- Product Details Section -->
    <div class="p-4 border-b border-gray-100">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Product Details</h3>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-gray-500">Created</span>
          <p id="panel-created" class="font-medium text-gray-900">—</p>
        </div>
        <div>
          <span class="text-gray-500">Updated</span>
          <p id="panel-updated" class="font-medium text-gray-900">—</p>
        </div>
      </div>
    </div>

    <!-- Price Section -->
    <div class="p-4 border-b border-gray-100">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Pricing</h3>
        <div id="auto-save-indicator" class="text-xs text-gray-400 hidden">
          <span class="saving hidden">Saving...</span>
          <span class="saved hidden text-green-600">Saved</span>
        </div>
      </div>
      <div class="price-input-wrapper">
        <label class="block text-sm text-gray-600 mb-2">Quote Price</label>
        <input
          type="text"
          id="panel-price-input"
          class="price-input w-full"
          placeholder="0.00"
        />
      </div>
    </div>

    <!-- Notes Section -->
    <div class="p-4">
      <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Internal Notes</h3>
      <textarea
        id="panel-notes"
        placeholder="Add internal notes about this quote..."
        rows="4"
        class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary transition-colors resize-none"
      ></textarea>
    </div>
  </div>

  <!-- Footer -->
  <div class="p-4 border-t border-gray-100 bg-gray-50/80">
    <div class="flex gap-3">
      <button
        id="panel-sync-btn"
        type="button"
        class="flex-1 px-4 py-2.5 text-gray-600 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 hover:border-gray-300 transition-all flex items-center justify-center gap-2"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Sync to CRM
      </button>
      <button
        id="panel-save-btn"
        type="button"
        class="flex-1 px-4 py-2.5 text-white bg-primary rounded-lg text-sm font-medium hover:bg-primary-dark transition-all shadow-sm hover:shadow"
      >
        Save Changes
      </button>
    </div>
    <p id="panel-sync-status" class="text-xs text-center text-gray-400 mt-2">Last synced: Never</p>
  </div>
</aside>

<style>
  /* Panel open state */
  #quote-panel.panel-open {
    transform: translateX(0);
  }

  #panel-backdrop.backdrop-visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Status buttons */
  .status-btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    background-color: #f3f4f6;
    color: #6b7280;
    border: 2px solid transparent;
    transition: all 0.15s ease;
  }

  .status-btn:hover {
    background-color: #e5e7eb;
  }

  .status-btn.active {
    border-color: currentColor;
  }

  .status-btn[data-status="new"].active { background-color: #dbeafe; color: #1d4ed8; }
  .status-btn[data-status="in_progress"].active { background-color: #fef3c7; color: #b45309; }
  .status-btn[data-status="sent"].active { background-color: #ede9fe; color: #7c3aed; }
  .status-btn[data-status="won"].active { background-color: #d1fae5; color: #047857; }
  .status-btn[data-status="lost"].active { background-color: #fee2e2; color: #b91c1c; }

  /* Product card */
  .product-card {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    padding: 1rem;
    transition: border-color 0.15s ease;
  }

  .product-card:focus-within {
    border-color: #00c16e;
  }

  /* Price input */
  .price-input {
    width: 120px;
    padding: 0.5rem 0.75rem;
    padding-left: 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    text-align: right;
    transition: all 0.15s ease;
  }

  .price-input:focus {
    outline: none;
    border-color: #00c16e;
    box-shadow: 0 0 0 3px rgba(0, 193, 110, 0.1);
  }

  .price-input-wrapper {
    position: relative;
  }

  .price-input-wrapper::before {
    content: '$';
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    font-size: 0.875rem;
  }

  /* Scrollbar */
  #quote-panel ::-webkit-scrollbar {
    width: 6px;
  }

  #quote-panel ::-webkit-scrollbar-track {
    background: transparent;
  }

  #quote-panel ::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    border-radius: 3px;
  }

  #quote-panel ::-webkit-scrollbar-thumb:hover {
    background-color: #9ca3af;
  }
</style>

<script>
  // Current quote data
  let currentQuote: any = null;
  let saveTimeout: ReturnType<typeof setTimeout> | null = null;

  // Elements
  const panel = document.getElementById('quote-panel');
  const backdrop = document.getElementById('panel-backdrop');
  const closeBtn = document.getElementById('close-panel');
  const saveBtn = document.getElementById('panel-save-btn');
  const syncBtn = document.getElementById('panel-sync-btn');
  const notesTextarea = document.getElementById('panel-notes') as HTMLTextAreaElement;
  const priceInput = document.getElementById('panel-price-input') as HTMLInputElement;
  const autoSaveIndicator = document.getElementById('auto-save-indicator');

  // Open panel
  function openPanel() {
    panel?.classList.add('panel-open');
    backdrop?.classList.add('backdrop-visible');
    document.body.style.overflow = 'hidden';
  }

  // Close panel
  function closePanel() {
    panel?.classList.remove('panel-open');
    backdrop?.classList.remove('backdrop-visible');
    document.body.style.overflow = '';
    currentQuote = null;
  }

  // Populate panel with quote data
  function populatePanel(quote: any) {
    currentQuote = quote;

    // Basic info
    const nameEl = document.getElementById('panel-name');
    const idEl = document.getElementById('panel-id');
    const created = document.getElementById('panel-created');
    const updated = document.getElementById('panel-updated');

    if (nameEl) nameEl.textContent = quote.name || 'Unnamed';
    if (idEl) idEl.textContent = quote.id || '';
    if (created) {
      created.textContent = quote.createdAt
        ? new Date(quote.createdAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })
        : '—';
    }
    if (updated) {
      updated.textContent = quote.updatedAt
        ? new Date(quote.updatedAt).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit'
          })
        : '—';
    }

    // Status
    document.querySelectorAll('.status-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.getAttribute('data-status') === quote.status) {
        btn.classList.add('active');
      }
    });

    // Price
    if (priceInput) {
      priceInput.value = quote.price ? formatPrice(quote.price) : '';
    }

    // Notes
    if (notesTextarea) {
      notesTextarea.value = quote.notes || '';
    }

    // Sync status
    const syncStatus = document.getElementById('panel-sync-status');
    if (syncStatus) {
      syncStatus.textContent = quote.lastSyncedAt
        ? `Last synced: ${formatRelativeTime(new Date(quote.lastSyncedAt))}`
        : 'Last synced: Never';
    }

    openPanel();
  }

  // Price input handler
  priceInput?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;

    // Format input as currency
    let value = target.value.replace(/[^0-9.]/g, '');
    const parts = value.split('.');
    if (parts.length > 2) {
      value = parts[0] + '.' + parts.slice(1).join('');
    }
    if (parts[1]?.length > 2) {
      value = parts[0] + '.' + parts[1].slice(0, 2);
    }
    target.value = value;

    // Update quote price
    if (currentQuote) {
      currentQuote.price = parseFloat(value) || 0;
      scheduleAutoSave();
    }
  });

  priceInput?.addEventListener('blur', (e) => {
    const target = e.target as HTMLInputElement;
    const value = parseFloat(target.value) || 0;
    target.value = value ? formatPrice(value) : '';
  });

  // Schedule auto-save with debounce
  function scheduleAutoSave() {
    if (saveTimeout) clearTimeout(saveTimeout);

    showSaveIndicator('saving');

    saveTimeout = setTimeout(async () => {
      await saveQuote();
    }, 500);
  }

  // Show save indicator
  function showSaveIndicator(state: 'saving' | 'saved') {
    if (!autoSaveIndicator) return;

    autoSaveIndicator.classList.remove('hidden');
    const saving = autoSaveIndicator.querySelector('.saving');
    const saved = autoSaveIndicator.querySelector('.saved');

    if (state === 'saving') {
      saving?.classList.remove('hidden');
      saved?.classList.add('hidden');
    } else {
      saving?.classList.add('hidden');
      saved?.classList.remove('hidden');
      setTimeout(() => {
        autoSaveIndicator.classList.add('hidden');
      }, 2000);
    }
  }

  // Save quote
  async function saveQuote() {
    if (!currentQuote) return;

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          status: currentQuote.status,
          price: currentQuote.price,
          notes: notesTextarea?.value || '',
        }),
      });

      if (!response.ok) throw new Error('Failed to save');

      showSaveIndicator('saved');

      // Update table
      window.dispatchEvent(new CustomEvent('quoteUpdated', { detail: { quote: currentQuote } }));
    } catch (error) {
      console.error('Failed to save quote:', error);
      // Could show error toast here
    }
  }

  // Sync to CRM
  async function syncToCRM() {
    if (!currentQuote) return;

    const btn = syncBtn;
    if (btn) {
      btn.setAttribute('disabled', 'true');
      btn.innerHTML = `
        <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
        Syncing...
      `;
    }

    try {
      const response = await fetch(`/api/admin/quotes/${currentQuote.id}/sync`, {
        method: 'POST',
      });

      if (!response.ok) throw new Error('Sync failed');

      const data = await response.json();

      // Update sync status
      const syncStatus = document.getElementById('panel-sync-status');
      if (syncStatus) {
        syncStatus.textContent = 'Last synced: Just now';
      }

      currentQuote.lastSyncedAt = new Date().toISOString();
    } catch (error) {
      console.error('Failed to sync:', error);
    } finally {
      if (btn) {
        btn.removeAttribute('disabled');
        btn.innerHTML = `
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Sync to CRM
        `;
      }
    }
  }

  // Event listeners
  closeBtn?.addEventListener('click', closePanel);
  backdrop?.addEventListener('click', closePanel);
  saveBtn?.addEventListener('click', saveQuote);
  syncBtn?.addEventListener('click', syncToCRM);

  // Status button handlers
  document.querySelectorAll('.status-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const status = btn.getAttribute('data-status');
      if (!status || !currentQuote) return;

      // Update UI
      document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update data
      currentQuote.status = status;
      scheduleAutoSave();
    });
  });

  // Notes auto-save
  notesTextarea?.addEventListener('input', () => {
    scheduleAutoSave();
  });

  // Close on escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && panel?.classList.contains('panel-open')) {
      closePanel();
    }
  });

  // Listen for open panel event
  window.addEventListener('openQuotePanel', (e: Event) => {
    const event = e as CustomEvent;
    populatePanel(event.detail.quote);
  });

  // Helper functions
  function formatPrice(value: number): string {
    return value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function formatRelativeTime(date: Date): string {
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    return `${diffDays}d ago`;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
