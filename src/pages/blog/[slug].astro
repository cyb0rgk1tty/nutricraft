---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import { getCollection, getEntry, render } from "astro:content";
import { slugify } from "../../utils/slugify";

export async function getStaticPaths() {
  const posts = await getCollection("blog", ({ data }) => {
    return data.draft !== true;
  });

  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

// For SSR mode, get the post directly
let { slug } = Astro.params;

// Strip .md extension if present (for backwards compatibility)
if (slug?.endsWith('.md')) {
  slug = slug.slice(0, -3);
}

const post = await getEntry("blog", slug);

// Redirect to 404 if post not found
if (!post || post.data.draft) {
  return Astro.redirect('/404');
}

const { Content } = await render(post);

const formattedDate = post.data.pubDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const formattedUpdatedDate = post.data.updatedDate?.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

// Get related posts by tags
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});

const relatedPosts = allPosts
  .filter((p) => {
    // Exclude current post
    if (p.id === post.id) return false;
    // Find posts with at least one matching tag
    return p.data.tags.some(tag => post.data.tags.includes(tag));
  })
  .slice(0, 3);

// SEO metadata
const pageTitle = post.data.title;
const pageDescription = post.data.description;
const pageImage = post.data.image?.url
  ? `https://Nutricraftlabs.com${post.data.image.url}`
  : 'https://Nutricraftlabs.com/images/og-image.jpg';
---

<BaseLayout
  title={`${pageTitle} - Nutricraft Labs Blog`}
  description={pageDescription}
  image={pageImage}
>
  <Header />

  <!-- Article Header -->
  <article class="bg-white">
    <header class="bg-gradient-to-b from-mint-50 to-white py-16 md:py-20">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-6">
          {post.data.tags.map((tag) => (
            <a
              href={`/blog/tag/${slugify(tag)}`}
              class="text-sm px-3 py-1 bg-mint-600/10 text-mint-700 rounded-full hover:bg-mint-600/20 transition-colors"
            >
              {tag}
            </a>
          ))}
        </div>

        <!-- Title -->
        <h1 class="text-4xl md:text-5xl font-bold text-dark-900 mb-6">
          {post.data.title}
        </h1>

        <!-- Meta -->
        <div class="flex flex-wrap items-center gap-4 text-dark-600">
          <span class="font-medium">{post.data.author}</span>
          <span class="text-gray-400">•</span>
          <time datetime={post.data.pubDate.toISOString()}>
            {formattedDate}
          </time>
          {formattedUpdatedDate && (
            <>
              <span class="text-gray-400">•</span>
              <span class="text-sm">Updated {formattedUpdatedDate}</span>
            </>
          )}
        </div>

        <!-- Featured Image -->
        {post.data.image && (
          <div class="mt-8 rounded-2xl overflow-hidden">
            <img
              src={post.data.image.url}
              alt={post.data.image.alt}
              class="w-full h-auto"
              loading="eager"
            />
          </div>
        )}
      </div>
    </header>

    <!-- Article Content -->
    <section class="py-16">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="prose prose-lg prose-gray max-w-none
                    prose-headings:font-bold prose-headings:text-dark-900
                    prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-4
                    prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-3
                    prose-p:text-dark-600 prose-p:leading-relaxed
                    prose-a:text-mint-600 prose-a:no-underline hover:prose-a:underline
                    prose-strong:text-dark-900 prose-strong:font-semibold
                    prose-ul:my-6 prose-li:text-dark-600
                    prose-img:rounded-lg prose-img:shadow-lg">
          <Content />
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="py-16 bg-gray-50">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl md:text-4xl font-bold text-dark-900 mb-6">
          Ready to Start Your Supplement Brand?
        </h2>
        <p class="text-xl text-dark-600 mb-8">
          Let's discuss how we can help bring your vision to life with our comprehensive manufacturing services.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <button
            data-cal-link="Nutricraftlabs"
            data-cal-config='{"theme":"light"}'
            class="inline-flex items-center justify-center px-8 py-4 bg-mint-600 text-white font-semibold rounded-lg hover:bg-mint-700 transition-colors duration-300"
          >
            Schedule a Call
            <svg
              class="ml-2 w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
          </button>
          <a
            href="/contact"
            class="inline-flex items-center justify-center px-8 py-4 bg-white text-mint-600 font-semibold rounded-lg border-2 border-mint-600 hover:bg-mint-50 transition-colors duration-300"
          >
            Get in Touch
            <svg
              class="ml-2 w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17 8l4 4m0 0l-4 4m4-4H3"
              ></path>
            </svg>
          </a>
        </div>
      </div>
    </section>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl font-bold text-dark-900 mb-8 text-center">
            Related Articles
          </h2>
          <div class="grid md:grid-cols-3 gap-8">
            {relatedPosts.map((relatedPost) => (
              <a
                href={`/blog/${relatedPost.id}`}
                class="group bg-gray-50 rounded-xl p-6 hover:shadow-lg transition-all duration-300"
              >
                {relatedPost.data.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2 mb-3">
                    {relatedPost.data.tags.slice(0, 2).map((tag) => (
                      <span class="text-xs px-2 py-1 bg-primary/10 text-primary rounded-full">
                        {tag}
                      </span>
                    ))}
                  </div>
                )}
                <h3 class="text-xl font-semibold text-dark-900 mb-2 group-hover:text-mint-600 transition-colors">
                  {relatedPost.data.title}
                </h3>
                <p class="text-dark-600 text-sm mb-3">
                  {relatedPost.data.description}
                </p>
                <span class="text-mint-600 text-sm font-medium group-hover:underline">
                  Read more →
                </span>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}
  </article>

  <Footer />
</BaseLayout>
