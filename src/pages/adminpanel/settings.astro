---
/**
 * Admin Settings Page
 * Manage site-wide settings like the announcement bar
 * Requires settings:view permission (Super Admin, Staff)
 * Only Super Admin can edit settings
 */
import BaseLayout from '../../layouts/BaseLayout.astro';
import { verifySession } from '../../utils/adminAuth';
import { getAnnouncement } from '../../utils/announcements';
import { hasPermission } from '../../utils/rbac';

// Check if user is already authenticated via cookie
const authResult = await verifySession(Astro.request);

// Redirect to quotes page if not authenticated (that page has the login form)
if (!authResult) {
  return Astro.redirect('/mandash');
}

// Check settings permission
if (!hasPermission(authResult.user.role, 'settings', 'view')) {
  return Astro.redirect('/mandash');
}

// Check if user can edit (Super Admin only)
const canEdit = hasPermission(authResult.user.role, 'settings', 'edit');

// Fetch current announcement
const announcement = await getAnnouncement();

// SEO metadata
const title = 'Settings | Nutricraft Labs Admin';
const description = 'Admin settings for Nutricraft Labs website';
---

<BaseLayout title={title} description={description} noindex={true} noChat={true}>
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-7xl mx-auto">
      <!-- Page Header -->
      <div class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="px-4 sm:px-6 lg:px-8 py-4">
          <div class="flex items-center justify-between">
            <div>
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900">Settings</h1>
              <p class="text-sm text-gray-500 mt-1">Manage site-wide configuration</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="px-4 sm:px-6 lg:px-8 py-6">
        <div class="max-w-2xl">
          <!-- Announcement Bar Settings -->
          <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gradient-to-r from-white to-amber-50">
              <h2 class="text-lg font-semibold text-gray-900">Announcement Bar</h2>
              <p class="text-sm text-gray-500 mt-1">Display a message at the top of all pages</p>
            </div>

            <form id="announcement-form" class="p-6 space-y-6">
              <!-- Toggle -->
              <div class="flex items-center justify-between">
                <div>
                  <label for="is-active" class="text-sm font-medium text-gray-900">Enable Announcement</label>
                  <p class="text-sm text-gray-500">Show the announcement bar on all pages</p>
                </div>
                <button
                  type="button"
                  id="is-active"
                  role="switch"
                  aria-checked={announcement?.is_active ? "true" : "false"}
                  disabled={!canEdit}
                  class:list={[
                    "relative inline-flex h-6 w-11 flex-shrink-0 rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",
                    announcement?.is_active ? "bg-primary" : "bg-gray-200",
                    canEdit ? "cursor-pointer" : "cursor-not-allowed opacity-60"
                  ]}
                >
                  <span
                    class:list={[
                      "pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out",
                      announcement?.is_active ? "translate-x-5" : "translate-x-0"
                    ]}
                  />
                </button>
              </div>

              <!-- Message -->
              <div>
                <label for="message" class="block text-sm font-medium text-gray-900 mb-2">Message</label>
                <textarea
                  id="message"
                  name="message"
                  rows="3"
                  readonly={!canEdit}
                  class:list={[
                    "w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none transition-colors resize-none",
                    !canEdit && "bg-gray-50 cursor-not-allowed"
                  ]}
                  placeholder="Enter announcement message..."
                >{announcement?.message || ''}</textarea>
                <p class="text-sm text-gray-500 mt-2">This message will be displayed at the top of every page.</p>
              </div>

              <!-- Preview -->
              <div>
                <label class="block text-sm font-medium text-gray-900 mb-2">Preview</label>
                <div id="preview" class="bg-amber-100 border border-amber-200 rounded-xl py-2.5 px-4">
                  <p id="preview-text" class="text-amber-900 text-sm text-center">
                    {announcement?.message || 'Your announcement will appear here...'}
                  </p>
                </div>
              </div>

              <!-- Save Button -->
              <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                <div id="save-status" class="text-sm text-gray-500">
                  {!canEdit && <span class="text-amber-600">View-only mode. Contact Super Admin to make changes.</span>}
                </div>
                {canEdit ? (
                  <button
                    type="submit"
                    id="save-btn"
                    class="px-6 py-2.5 bg-primary text-white font-semibold rounded-lg hover:bg-primary-dark transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Save Changes
                  </button>
                ) : (
                  <span class="px-6 py-2.5 bg-gray-300 text-gray-500 font-semibold rounded-lg cursor-not-allowed">
                    Read-Only
                  </span>
                )}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script define:vars={{ announcementId: announcement?.id, canEdit }}>
  // Elements
  const form = document.getElementById('announcement-form');
  const toggleBtn = document.getElementById('is-active');
  const messageInput = document.getElementById('message');
  const previewText = document.getElementById('preview-text');
  const saveBtn = document.getElementById('save-btn');
  const saveStatus = document.getElementById('save-status');

  let isActive = toggleBtn?.getAttribute('aria-checked') === 'true';

  // Toggle handler
  toggleBtn?.addEventListener('click', () => {
    // Prevent toggle if user doesn't have edit permission
    if (!canEdit) return;

    isActive = !isActive;
    toggleBtn.setAttribute('aria-checked', isActive ? 'true' : 'false');

    if (isActive) {
      toggleBtn.classList.remove('bg-gray-200');
      toggleBtn.classList.add('bg-primary');
      toggleBtn.querySelector('span')?.classList.remove('translate-x-0');
      toggleBtn.querySelector('span')?.classList.add('translate-x-5');
    } else {
      toggleBtn.classList.remove('bg-primary');
      toggleBtn.classList.add('bg-gray-200');
      toggleBtn.querySelector('span')?.classList.remove('translate-x-5');
      toggleBtn.querySelector('span')?.classList.add('translate-x-0');
    }
  });

  // Live preview
  messageInput?.addEventListener('input', (e) => {
    const value = (e.target as HTMLTextAreaElement).value;
    if (previewText) {
      previewText.textContent = value || 'Your announcement will appear here...';
    }
  });

  // Form submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Prevent submission if user doesn't have edit permission
    if (!canEdit) {
      showStatus('You do not have permission to edit settings', true);
      return;
    }

    if (!announcementId) {
      showStatus('Error: No announcement found', true);
      return;
    }

    const message = (messageInput as HTMLTextAreaElement)?.value?.trim();

    if (!message) {
      showStatus('Please enter a message', true);
      return;
    }

    // Disable button
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
    }

    try {
      const response = await fetch('/api/adminpanel/announcements', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: announcementId,
          is_active: isActive,
          message: message,
        }),
      });

      const data = await response.json();

      if (response.ok && data.success) {
        showStatus('Saved successfully!', false);
      } else {
        showStatus(data.error || 'Failed to save', true);
      }
    } catch (error) {
      console.error('Save error:', error);
      showStatus('An error occurred', true);
    } finally {
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }
  });

  function showStatus(message: string, isError: boolean) {
    if (saveStatus) {
      saveStatus.textContent = message;
      saveStatus.className = `text-sm ${isError ? 'text-red-600' : 'text-green-600'}`;

      // Clear after 3 seconds
      setTimeout(() => {
        saveStatus.textContent = '';
      }, 3000);
    }
  }
</script>
