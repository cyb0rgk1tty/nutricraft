---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PasswordGate from '../components/catalog/PasswordGate.astro';
import CatalogHero from '../components/catalog/CatalogHero.astro';
import FloatingFilterButton from '../components/catalog/FloatingFilterButton.astro';
import FilterDrawer from '../components/catalog/FilterDrawer.astro';
import CategorySection from '../components/catalog/CategorySection.astro';
import {
  getProductsByCategoryForCatalog,
  getDosageFormCountsForCatalog,
  getCategoriesForCatalog,
  getUniqueIngredients,
  type ComponentProduct
} from '../utils/db';

// Get password from environment variable (required)
const CATALOG_PASSWORD = import.meta.env.CATALOG_PASSWORD;

// Fetch data from Supabase
const [productsByCategory, dosageForms, productCategories, uniqueIngredients] = await Promise.all([
  getProductsByCategoryForCatalog(),
  getDosageFormCountsForCatalog(),
  getCategoriesForCatalog(),
  getUniqueIngredients(),
]);

// Calculate total products
const totalProducts = productsByCategory.reduce((sum, cat) => sum + cat.products.length, 0);
---

<BaseLayout
  title="Product Catalog | Nutricraft Labs"
  description="Browse our complete catalog of stock supplement formulas. GMP-certified, ready for private label or white label manufacturing."
  noindex={true}
>
  <Header />

  <PasswordGate password={CATALOG_PASSWORD}>
    <CatalogHero />

    <main id="catalog-products" class="pb-20 bg-gray-50">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        {productsByCategory.map((category, index) => (
          <CategorySection
            category={category}
            products={category.products}
            isFirst={index === 0}
          />
        ))}
      </div>
    </main>

    <!-- Floating Filter Button & Drawer -->
    <FloatingFilterButton />
    <FilterDrawer
      categories={productCategories}
      dosageForms={dosageForms}
      totalProducts={totalProducts}
      uniqueIngredients={uniqueIngredients}
    />
  </PasswordGate>

  <Footer />
</BaseLayout>
