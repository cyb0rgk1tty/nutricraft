---
import { SEO } from 'astro-seo';
import ChatSupport from '../components/ChatSupport.astro';
import Analytics from '../components/Analytics.astro';
import '../styles/tailwind.css';

export interface Props {
  title?: string;
  description?: string;
  image?: string;
}

const { 
  title = 'Nutricraft Labs | Private-Label Supplements, NPN & GMP Partner Network (Canada/US)',
  description = 'Launch compliant supplements faster. We connect you with vetted GMP manufacturers and handle NPN, labels, and packaging. Free consultation.',
  image = '/images/nutricraftbottle-optimized.png',
  noindex = false
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    
    <!-- Initialize dataLayer for GTM -->
    <script>
      window.dataLayer = window.dataLayer || [];
    </script>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KDM7H2RL');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://chat.tangleapps.vip" />
    <link rel="dns-prefetch" href="https://www.google-analytics.com" />
    <link rel="dns-prefetch" href="https://chat.tangleapps.vip" />
    
    <SEO
      title={title}
      description={description}
      openGraph={{
        basic: {
          title,
          type: "website",
          image,
          url: canonicalURL.href
        },
        optional: {
          description,
          siteName: "Nutricraft Labs"
        }
      }}
      twitter={{
        creator: "@nutricraftlabs",
        site: "@nutricraftlabs",
        card: "summary_large_image"
      }}
      extend={{
        link: [
          { rel: "canonical", href: canonicalURL.href },
          { rel: "sitemap", href: "/sitemap.xml" },
          { rel: "alternate", hreflang: "en-CA", href: canonicalURL.href },
          { rel: "alternate", hreflang: "fr-CA", href: canonicalURL.href.replace('.com', '.com/fr') },
          { rel: "alternate", hreflang: "x-default", href: canonicalURL.href },
          { 
            rel: "preconnect", 
            href: "https://fonts.googleapis.com" 
          },
          { 
            rel: "preconnect", 
            href: "https://fonts.gstatic.com",
            crossorigin: true
          },
          {
            rel: "preload",
            as: "style",
            href: "https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
          },
          {
            href: "https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap",
            rel: "stylesheet",
            media: "print",
            onload: "this.media='all'; this.onload=null;"
          },
          {
            rel: "dns-prefetch",
            href: "https://schema.org"
          }
        ],
        meta: [
          { name: "robots", content: noindex ? "noindex, nofollow" : "index, follow" },
          { name: "googlebot", content: noindex ? "noindex, nofollow" : "index, follow, max-image-preview:large" },
          { property: "og:locale", content: "en_US" },
          { property: "og:locale:alternate", content: "fr_CA" },
          { name: "author", content: "Nutricraft Labs" },
          { name: "theme-color", content: "#A8E6CF" },
          { name: "format-detection", content: "telephone=no" }
        ]
      }}
    />
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "Nutricraft Labs",
        "description": "Private-label supplements and regulatory compliance services for North America",
        "url": "https://nutricraftlabs.com",
        "logo": "https://nutricraftlabs.com/images/logo-og.jpg",
        "contactPoint": {
          "@type": "ContactPoint",
          "email": "hello@nutricraftlabs.com",
          "contactType": "sales",
          "availableLanguage": ["English", "French"]
        },
        "sameAs": [
          "https://www.linkedin.com/company/nutricraftlabs",
          "https://twitter.com/nutricraftlabs"
        ],
        "areaServed": ["CA", "US"],
        "serviceArea": {
          "@type": "GeoCircle",
          "geoMidpoint": {
            "@type": "GeoCoordinates",
            "latitude": "43.653226",
            "longitude": "-79.3831843"
          },
          "geoRadius": "5000000"
        },
        "offers": {
          "@type": "AggregateOffer",
          "priceCurrency": "CAD",
          "lowPrice": "500",
          "offerCount": "8"
        }
      }
    </script>
    
    <!-- LocalBusiness Schema -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "LocalBusiness",
        "name": "Nutricraft Labs",
        "description": "Private-label supplement manufacturing matchmaking and regulatory compliance services",
        "url": "https://nutricraftlabs.com",
        "telephone": "",
        "email": "hello@nutricraftlabs.com",
        "address": {
          "@type": "PostalAddress",
          "addressLocality": "Toronto",
          "addressRegion": "ON",
          "addressCountry": "CA"
        },
        "geo": {
          "@type": "GeoCoordinates",
          "latitude": "43.653226",
          "longitude": "-79.3831843"
        },
        "openingHours": "Mo-Fr 09:00-17:00",
        "priceRange": "$$$"
      }
    </script>
    
    <!-- Fallback for browsers with JavaScript disabled -->
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
    </noscript>
    
    <!-- Critical CSS for above-the-fold content -->
    <style>
      /* Critical CSS for faster initial paint */
      * { box-sizing: border-box; }
      body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
      img { max-width: 100%; height: auto; }
      
      /* Font display swap for web fonts */
      @font-face {
        font-family: 'Inter';
        font-display: swap;
        src: local('Inter');
      }
      
      .bg-gradient-to-b { background: linear-gradient(to bottom, var(--tw-gradient-from), var(--tw-gradient-to)); }
      .from-mint-50 { --tw-gradient-from: #f0fdf6; }
      .to-white { --tw-gradient-to: #ffffff; }
      .text-dark-900 { color: #111827; }
      .text-dark-600 { color: #4b5563; }
      .max-w-7xl { max-width: 80rem; }
      .mx-auto { margin-left: auto; margin-right: auto; }
      .px-4 { padding-left: 1rem; padding-right: 1rem; }
      .py-16 { padding-top: 4rem; padding-bottom: 4rem; }
      .grid { display: grid; }
      .gap-12 { gap: 3rem; }
      .space-y-6 > * + * { margin-top: 1.5rem; }
      .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
      .font-bold { font-weight: 700; }
      .leading-tight { line-height: 1.25; }
      .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
      .leading-relaxed { line-height: 1.625; }
      .bg-mint-600 { background-color: #00c896; }
      .text-white { color: #ffffff; }
      .rounded-lg { border-radius: 0.5rem; }
      .inline-flex { display: inline-flex; }
      .items-center { align-items: center; }
      .justify-center { justify-content: center; }
      .px-8 { padding-left: 2rem; padding-right: 2rem; }
      .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
      @media (min-width: 768px) {
        .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .md\\:py-24 { padding-top: 6rem; padding-bottom: 6rem; }
        .md\\:text-5xl { font-size: 3rem; line-height: 1; }
      }
      @media (min-width: 1024px) {
        .lg\\:text-6xl { font-size: 3.75rem; line-height: 1; }
        .lg\\:px-8 { padding-left: 2rem; padding-right: 2rem; }
      }
    </style>
  </head>
  <body class="bg-white text-gray-900">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KDM7H2RL"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <slot />
    <ChatSupport />
    <Analytics />
    
    <!-- Calendar Booking Conversion Tracking for GTM -->
    <script>
      window.gtag_report_conversion = function(url) {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          'event': 'calendar_booking',
          'conversion_id': 'AW-17548601361/PLcGCKGKGboZwbEJHQ6a9B',
          'value': 1.0,
          'currency': 'CAD'
        });
        
        if (typeof(url) != 'undefined') {
          setTimeout(function() {
            window.location = url;
          }, 100);
        }
        return false;
      }
    </script>
    
    <!-- Cal.com Embed Script -->
    <script>
      (function (C, A, L) {
        let p = function (a, ar) {
          a.q.push(ar);
        };
        let d = C.document;
        C.Cal =
          C.Cal ||
          function () {
            let cal = C.Cal;
            let ar = arguments;
            if (!cal.loaded) {
              cal.ns = {};
              cal.q = cal.q || [];
              d.head.appendChild(d.createElement("script")).src = A;
              cal.loaded = true;
            }
            if (ar[0] === L) {
              const api = function () {
                p(api, arguments);
              };
              const namespace = ar[1];
              api.q = api.q || [];
              if (typeof namespace === "string") {
                cal.ns[namespace] = cal.ns[namespace] || api;
                p(cal.ns[namespace], ar);
              } else p(cal, ar);
              return;
            }
            p(cal, ar);
          };
      })(window, "https://app.cal.com/embed/embed.js", "init");
      
      // Initialize Cal.com when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          Cal("init", {
            origin: "https://app.cal.com"
          });
          
          // Initialize UI for handling button clicks
          Cal("ui", {
            cssVarsPerTheme: {
              light: {
                "cal-brand": "#00c896"
              }
            },
            hideEventTypeDetails: false,
            layout: "month_view"
          });
          
          // Listen for booking success from popup calendars
          Cal("on", {
            action: "bookingSuccessful",
            callback: (e) => {
              console.log("Booking successful (popup):", e.detail);
              // Track Google Ads conversion for calendar bookings
              window.dataLayer = window.dataLayer || [];
              window.dataLayer.push({
                'event': 'calendar_booking',
                'conversion_id': 'AW-17548601361/PLcGCKGKGboZwbEJHQ6a9B',
                'value': 1.0,
                'currency': 'CAD'
              });
              
              // Also call the conversion function if it exists
              if (typeof window.gtag_report_conversion === 'function') {
                window.gtag_report_conversion();
              }
            }
          });
        });
      } else {
        // DOM already loaded
        Cal("init", {
          origin: "https://app.cal.com"
        });
        
        Cal("ui", {
          cssVarsPerTheme: {
            light: {
              "cal-brand": "#00c896"
            }
          },
          hideEventTypeDetails: false,
          layout: "month_view"
        });
        
        // Listen for booking success from popup calendars
        Cal("on", {
          action: "bookingSuccessful",
          callback: (e) => {
            console.log("Booking successful (popup):", e.detail);
            // Track Google Ads conversion for calendar bookings
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
              'event': 'calendar_booking',
              'conversion_id': 'AW-17548601361/PLcGCKGKGboZwbEJHQ6a9B',
              'value': 1.0,
              'currency': 'CAD'
            });
            
            // Also call the conversion function if it exists
            if (typeof window.gtag_report_conversion === 'function') {
              window.gtag_report_conversion();
            }
          }
        });
      }
    </script>
  </body>
</html>