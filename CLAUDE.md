# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Development
```bash
npm run dev          # Start Astro dev server (access at http://192.168.50.5:4321)
npm run build        # Build production site to dist/
npm run preview      # Preview production build locally
npm run astro        # Access Astro CLI directly
```

**Important**: The dev server should always run on `0.0.0.0` to be accessible at `http://192.168.50.5:4321`. Use:
```bash
npm run dev -- --host 0.0.0.0
```

### Astro CLI Commands
```bash
npx astro add        # Add integrations
npx astro check      # Check for TypeScript errors
npx astro sync       # Generate TypeScript types for content collections
```

## Architecture

### Tech Stack
- **Framework**: Astro.js v5 with SSR enabled (Vercel adapter)
- **Styling**: Tailwind CSS with custom mint green theme
- **Email**: Nodemailer for contact form submissions
- **Analytics**: Google Tag Manager integration
- **TypeScript**: Strict mode enabled

### Project Structure

```
src/
├── pages/             # Routes - file-based routing
│   ├── api/          # API endpoints (contact.ts for form handling)
│   ├── blog/         # Blog pages and routes
│   │   ├── index.astro        # Blog listing page
│   │   ├── [slug].astro       # Individual blog post pages
│   │   └── tag/
│   │       └── [tag].astro    # Tag filter pages (auto-generated)
│   ├── dosage-forms/ # Dynamic routes with [format].astro
│   └── services/     # Service pages
│       └── _drafts/  # Unpublished service pages (not built)
├── components/       # Reusable Astro components
│   └── BlogCard.astro # Blog post preview cards
├── layouts/         # BaseLayout.astro wraps all pages
├── content/         # Content collections (Astro Content Layer)
│   ├── blog/        # Markdown blog posts
│   └── dosage-forms/ # Dosage form content
├── utils/           # Utility functions
│   └── slugify.ts   # URL slugification for tags
└── data/           # JS data files (services, formulations, etc.)
```

### Key Patterns

1. **Dynamic Routes**: The `[format].astro` pattern in dosage-forms/ creates pages based on formulation data; `[slug].astro` in blog/ creates individual blog post pages; `[tag].astro` creates tag filter pages
2. **Component Composition**: All pages use BaseLayout.astro with SEO metadata
3. **Content Collections**: Blog posts and dosage forms use Astro's Content Layer API with glob loaders defined in `src/content/config.ts`
4. **Data Management**: Product data stored in src/data/ as JavaScript modules; blog content in Markdown files
5. **Image Optimization**: Scripts in scripts/ folder for image processing with sharp-cli
6. **Environment Variables**: SMTP configuration in .env for contact form
7. **Canonical URLs**: Automatically generated by BaseLayout.astro using `Astro.url.pathname` and `Astro.site` - DO NOT hardcode canonical URLs in individual pages
8. **SSR Mode**: Site runs in SSR mode with Vercel adapter
   - `getStaticPaths()` is IGNORED in SSR mode - do not rely on `Astro.props` from it
   - Dynamic routes must fetch data at runtime using `getEntry()` or `getCollection()`
   - Blog post pages: Use `getEntry('blog', slug)` at runtime
   - Tag pages: Fetch all posts with `getCollection()` and filter at runtime

### API Endpoints
- `/api/contact` - Handles contact form submissions via Nodemailer

### Content Collections & Blog

Blog functionality using Astro's Content Layer API:
- **Blog Posts**: Markdown files in `src/content/blog/`
- **Collection Config**: Defined in `src/content/config.ts` with glob loader
- **Blog Routes**:
  - `/blog` - Main blog listing page with tag cloud
  - `/blog/[slug]` - Individual blog post pages (e.g., `/blog/private-label-vs-white-label`)
  - `/blog/tag/[tag]` - Tag filter pages (e.g., `/blog/tag/product-development`)
- **Adding New Posts**:
  1. Create `.md` file in `src/content/blog/`
  2. Required frontmatter: `title`, `description`, `pubDate`, `author`, `tags`, `draft`
  3. Use Title Case for tags (e.g., "Private Label", "Product Development")
  4. Tags automatically convert to URL-safe slugs via `slugify()` utility
  5. Set `draft: false` to publish (draft posts excluded from listings)
- **Tag System**:
  - Tags display in Title Case (e.g., "Private Label")
  - URLs automatically slugified (e.g., `/blog/tag/private-label`)
  - Handled by `src/utils/slugify.ts` utility function
  - Tag filter pages work in SSR mode by fetching data at runtime
- **SSR Implementation**:
  - Blog post pages use `getEntry()` at runtime (SSR mode ignores `getStaticPaths()`)
  - Tag pages fetch all posts at runtime and filter by matching tag
  - Slugified URLs reverse-lookup to find original Title Case tag names
  - 404 redirect if post or tag not found
- **Content Width**: Articles use `max-w-4xl` (896px) for optimal table/content display
- **SEO Optimized**: Meta descriptions, structured headings, internal linking, FAQ sections
- **Current Posts**: 2 comprehensive articles (4,200+ and 5,800+ words)
  - "Private Label vs White Label: What's the Difference?" (Sept 30, 2025)
  - "How to Choose the Right Dosage Form for Your Supplement" (Sept 26, 2025)

### Deployment
- Site deployed on Vercel (output: 'server', adapter: vercel())
- Domain: https://nutricraftlabs.com
- **Sitemap**: Automatically discovers all routes during build
  - Astro sitemap integration auto-discovers routes with `getStaticPaths()`
  - Includes all blog posts and tag filter pages
  - Static pages manually listed in `astro.config.mjs` customPages
  - No manual updates needed when adding new blog posts

### Image Optimization
Image optimization scripts available in scripts/ directory:
- `optimize-formulation-images.sh` - Creates multiple sizes and WebP formats
- `convert-png-to-jpg.sh` - Batch converts PNG to JPG
- Various format-specific optimization scripts

### Forms & Contact
Contact form uses server-side processing with:
- Validation on both client and server
- Nodemailer for SMTP email sending
- Environment variables for SMTP configuration

### Analytics & Tracking
- Google Tag Manager integration via Analytics.astro component
- Conversion tracking documentation in CONVERSION_TRACKING.md
- GTM setup guide in GTM_SETUP.md

## Development Notes

- TypeScript strict mode is enabled
- No ESLint or Prettier configuration (consider adding for consistency)
- Tests directory exists but is currently empty
- Public images should be placed in public/images/ with WebP versions for performance
- The brand of this project is "Nutricraft Labs"

### Blog Writing Guidelines

When creating new blog articles:
- **Word Count**: Aim for 3,000-5,000+ words for comprehensive coverage
- **Tone**: Conversational, human-written style with contractions and varied sentences
- **No AI Patterns**: Avoid em-dashes, generic phrasing, or robotic tone
- **Pricing**: Show typical price ranges with soft disclaimers (e.g., "Pricing varies based on formulation complexity...")
- **Tables**: Use Markdown tables for comparisons, cost breakdowns, decision matrices
- **Internal Linking**: Link to relevant service pages (e.g., `/services/private-white-label-manufacturing`)
- **Real Data**: Use actual Nutricraft pricing and specifications:
  - 1,000 unit MOQ (vs industry 5,000+)
  - 210+ stock formulas
  - FDA-registered, GMP-certified
  - White label: $8-12K, Private label: $15-25K
- **SEO**: Include FAQ sections, long-tail keywords, comprehensive comparisons
- **Manufacturing Perspective**: Write from insider/manufacturing floor viewpoint